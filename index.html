<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>POWERINGUASTI</title>
  <meta name="description" content="Monitoraggio guasti elettrici in Italia con mappa interattiva e filtri avanzati." />
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin>
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <!-- Leaflet Routing Machine CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"
  />
  <style>
    :root{ --bg:#e8f3f6; --panel:#ffffff; --panel-2:#ffffff; --text:#0e1621; --muted:#42586e; --accent:#1e88e5; --accent-2:#4aa3ff; --ok:#16d19a; --warn:#ff9f1c; --err:#ff6b6b; --chip:#f1f5fa; --chip-border:#d8e2ee; --shadow:0 14px 28px rgba(0,0,0,.18); --bd:#e6edf5; --gradient-primary:linear-gradient(135deg,#667eea 0%,#764ba2 100%); --gradient-secondary:linear-gradient(135deg,#f093fb 0%,#f5576c 100%); --safe-area-top:env(safe-area-inset-top); --safe-area-bottom:env(safe-area-inset-bottom); --safe-area-left:env(safe-area-inset-left); --safe-area-right:env(safe-area-inset-right); }

    /* ===== SPLASH SCREEN CINEMATOGRAFICO ===== */
    #splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 25%, #16213e  50%, #0f0f23 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      overflow: hidden;
      opacity: 1;
      transition: opacity 1s ease-out, transform 1s ease-out;
      padding: var(--safe-area-top) var(--safe-area-right) var(--safe-area-bottom) var(--safe-area-left);
    }

    #splash-screen.fade-out {
      opacity: 0;
      transform: scale(1.1);
      pointer-events: none;
    }

    /* Particelle elettriche animate */
    .particles {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      pointer-events: none;
    }

    .particle {
      position: absolute;
      width: 3px;
      height: 3px;
      background: #00d4ff;
      border-radius: 50%;
      box-shadow: 0 0 6px #00d4ff, 0 0 12px #00d4ff, 0 0 18px #00d4ff;
      animation: float 6s infinite linear;
      opacity: 0;
    }

    @keyframes float {
      0% { transform: translateY(100vh) translateX(0); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-10vh) translateX(50px); opacity: 0; }
    }

    /* Logo 3D animato */
    .splash-logo {
      width: 120px;
      height: 120px;
      margin-bottom: 30px;
      position: relative;
      animation: logoEntrance 2s ease-out, logoFloat 3s ease-in-out 2s infinite alternate;
      filter: drop-shadow(0 0 20px rgba(30, 136, 229, 0.6));
    }

    .splash-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      animation: logoRotate 4s ease-in-out infinite;
      filter: brightness(1.2) contrast(1.1);
    }

    @keyframes logoEntrance {
      0% { 
        transform: scale(0) rotate(180deg);
        opacity: 0;
        filter: blur(10px);
      }
      60% { 
        transform: scale(1.2) rotate(-10deg);
        opacity: 0.8;
        filter: blur(2px);
      }
      100% { 
        transform: scale(1) rotate(0deg);
        opacity: 1;
        filter: blur(0px);
      }
    }

    @keyframes logoRotate {
      0%, 100% { transform: rotateY(0deg) rotateX(0deg); }
      25% { transform: rotateY(-15deg) rotateX(5deg); }
      50% { transform: rotateY(0deg) rotateX(-10deg); }
      75% { transform: rotateY(15deg) rotateX(5deg); }
    }

    @keyframes logoFloat {
      0% { transform: translateY(0px); }
      100% { transform: translateY(-10px); }
    }

    /* Testo con effetto typing cinematografico */
    .splash-title {
      font-size: 32px;
      font-weight: 800;
      letter-spacing: 3px;
      color: transparent;
      background: linear-gradient(45deg, #00d4ff, #0099cc, #ffffff, #00d4ff);
      background-size: 400% 400%;
      -webkit-background-clip: text;
      background-clip: text;
      text-align: center;
      margin-bottom: 40px;
      animation: textShimmer 3s ease-in-out infinite, textEntrance 1.5s ease-out 0.5s both;
      text-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
      position: relative;
    }

    .splash-title::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #00d4ff, transparent, #00d4ff);
      border-radius: 8px;
      z-index: -1;
      opacity: 0.3;
      animation: borderGlow 2s ease-in-out infinite alternate;
    }

    @keyframes textEntrance {
      0% { 
        opacity: 0;
        transform: translateY(30px) scale(0.8);
        filter: blur(10px);
      }
      100% { 
        opacity: 1;
        transform: translateY(0px) scale(1);
        filter: blur(0px);
      }
    }

    @keyframes textShimmer {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes borderGlow {
      0% { opacity: 0.2; transform: scale(1); }
      100% { opacity: 0.6; transform: scale(1.05); }
    }

    /* Sottotitolo */
    .splash-subtitle {
      font-size: 14px;
      color: #a0c4ff;
      text-align: center;
      margin-bottom: 50px;
      opacity: 0;
      animation: subtitleEntrance 1s ease-out 1.5s both;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    @keyframes subtitleEntrance {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0px); }
    }

    /* Barra di caricamento cinematografica */
    .loading-container {
      width: 300px;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(0, 212, 255, 0.3);
      opacity: 0;
      animation: loadingEntrance 0.8s ease-out 2s both;
    }

    .loading-bar {
      height: 100%;
      background: linear-gradient(90deg, #00d4ff, #0099cc, #ffffff, #00d4ff);
      background-size: 200% 100%;
      border-radius: 10px;
      width: 0%;
      animation: loadingProgress 3s ease-in-out 2.5s both, loadingShimmer 1.5s ease-in-out 2.5s infinite;
      position: relative;
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.6);
    }

    .loading-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      animation: loadingScan 2s ease-in-out infinite;
    }

    @keyframes loadingEntrance {
      0% { opacity: 0; transform: scaleX(0); }
      100% { opacity: 1; transform: scaleX(1); }
    }

    @keyframes loadingProgress {
      0% { width: 0%; }
      20% { width: 15%; }
      40% { width: 35%; }
      60% { width: 65%; }
      80% { width: 85%; }
      100% { width: 100%; }
    }

    @keyframes loadingShimmer {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes loadingScan {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* Testo di caricamento */
    .loading-text {
      color: #a0c4ff;
      font-size: 12px;
      text-align: center;
      margin-top: 20px;
      opacity: 0;
      animation: loadingTextEntrance 0.8s ease-out 3s both;
      letter-spacing: 1px;
    }

    @keyframes loadingTextEntrance {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0px); }
    }

    /* Effetti di luce ambiente */
    .splash-screen::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, rgba(0, 212, 255, 0.1) 0%, transparent 70%);
      transform: translate(-50%, -50%);
      animation: ambientGlow 4s ease-in-out infinite alternate;
      pointer-events: none;
    }

    @keyframes ambientGlow {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.3; }
      100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.1; }
    }

    /* Responsivo mobile */
    @media (max-width: 768px) {
      .splash-logo {
        width: 100px;
        height: 100px;
        margin-bottom: 25px;
      }

      .splash-title {
        font-size: 24px;
        letter-spacing: 2px;
        margin-bottom: 30px;
      }

      .splash-subtitle {
        font-size: 12px;
        margin-bottom: 40px;
        letter-spacing: 1px;
      }

      .loading-container {
        width: 250px;
        height: 5px;
      }

      .loading-text {
        font-size: 11px;
        margin-top: 15px;
      }
    }

    /* Nascondi l'app principale durante lo splash */
    body.splash-active .app {
      display: none;
    }
    *{box-sizing:border-box}
    html,body{height:100%;height:100vh;height:100dvh}
    body{margin:0;background:var(--bg);color:var(--text);font:14px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial;transition:all 0.3s ease;padding-top:var(--safe-area-top);padding-bottom:var(--safe-area-bottom);padding-left:var(--safe-area-left);padding-right:var(--safe-area-right)}

    /* Animazioni */
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes slideIn{from{transform:translateX(-100%)}to{transform:translateX(0)}}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}

    .animate-fade{animation:fadeIn 0.6s ease-out}
    .animate-slide{animation:slideIn 0.4s ease-out}
    .animate-pulse{animation:pulse 2s infinite}
    .animate-bounce{animation:bounce 1s infinite}
    .app{display:grid;grid-template-columns:360px 1fr;grid-template-rows:1fr;height:100vh;height:100dvh}
    @media (max-width: 980px){.app{grid-template-columns:1fr;grid-template-rows:1fr;height:calc(100vh - var(--safe-area-top) - var(--safe-area-bottom));height:calc(100dvh - var(--safe-area-top) - var(--safe-area-bottom))}}
    header{grid-column:1/-1;display:flex;align-items:center;gap:4px;padding:12px 16px;background:none;border:none;position:absolute;top:8px;left:0;right:0;z-index:10001;box-shadow:none;backdrop-filter:none;min-height:72px;pointer-events:none}
    
    /* Classe per abbassare z-index quando le modali sono aperte */
    header.modal-open {
      z-index: 1000 !important;
    }
    .brand-title{font-size:16px;font-weight:800;letter-spacing:.2px;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,0.8), 0 0 8px rgba(255,255,255,0.2);display:flex;align-items:center;pointer-events:auto;opacity:0.85;border:2px solid #333;border-radius:8px;padding:4px 8px;background:rgba(0,0,0,0.3)}
    .logo{height:72px;width:72px;display:flex;align-items:center;justify-content:center;margin-right:4px;flex-shrink:0;pointer-events:auto;transition:transform 0.3s ease}
    .logo img{max-width:100%;max-height:100%;object-fit:contain}
    

    /* Mobile header ottimizzato */
    @media (max-width: 768px){
      header{padding:10px 16px;min-height:80px;gap:4px;top:12px}
      .logo{height:68px;width:68px;margin-right:4px}
      .brand-title{font-size:14px;opacity:0.9}
      .brand-title img{height:18px!important}
      
      /* Logo hover effect mobile */
      .logo:active{
        transform:scale(0.95);
      }
    }
    .sidebar{background:var(--panel);border-right:1px solid var(--bd);padding:14px 14px 16px;overflow:auto}
    @media (max-width: 980px){.sidebar{grid-row:2;grid-column:1;order:2;position:fixed;top:56px;left:0;right:0;bottom:0;height:calc(100vh - 56px - var(--safe-area-top) - var(--safe-area-bottom));height:calc(100dvh - 56px - var(--safe-area-top) - var(--safe-area-bottom));transform:translateY(-100%);opacity:0;pointer-events:none;transition:all .25s cubic-bezier(0.4,0,0.2,1);background:rgba(255,255,255,0.98);backdrop-filter:blur(12px);z-index:1500;padding:12px 16px 16px}.sidebar[data-open="true"]{transform:translateY(0);opacity:1;pointer-events:auto}

    /* Indicatore per aprire sidebar mobile */
    .sidebar::before{content:'';position:absolute;top:-8px;left:50%;transform:translateX(-50%);width:40px;height:4px;background:#ccc;border-radius:2px;display:block}

    @media (min-width: 981px){.sidebar::before{display:none}}}
    .section{background:var(--panel-2);border:1px solid var(--bd);border-radius:18px;margin:10px 0;padding:12px 12px 14px;box-shadow:var(--shadow)}
    .section h3{margin:4px 0 10px;font-size:13px;color:#264a71;font-weight:800;letter-spacing:.2px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--chip-border);padding:8px 12px;border-radius:999px;cursor:pointer;user-select:none;transition:all .15s}
    .chip[data-active="true"]{outline:2px solid var(--accent-2);color:#0b2540}
    .legend{display:grid;grid-template-columns:16px 1fr;gap:10px;align-items:center}
    #map{width:100%;height:100%}
    .leaflet-popup-content{margin:8px 12px}
    .leaflet-container a{color:#0b7dda}
    .toast{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);background:#11161c;color:#dce7f4;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:1500}
    .toast[data-show="true"]{opacity:1;pointer-events:auto}

    .fab{position:fixed;right:12px;top:58px;display:flex;flex-direction:column;gap:12px;z-index:900}
    .fab button{width:54px;height:54px;border-radius:14px;border:1px solid rgba(255,255,255,.55);display:grid;place-items:center;cursor:pointer;box-shadow:0 10px 22px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.35);transition:transform .08s ease, box-shadow .2s ease}
    .fab button:active{transform:translateY(1px)}
    .fab svg.icon-stroke{width:22px;height:22px;stroke:#fff;stroke-width:2;fill:none;stroke-linecap:round;stroke-linejoin:round}
    .fab .b-filter{background:linear-gradient(180deg,#4aa3ff,#1e88e5)}
    .fab .b-analytics{background:linear-gradient(180deg,#33d37b,#1b8f4e)}
    .fab .b-layers{background:linear-gradient(180deg,#626973,#3b3f47)}
    .fab .b-settings{background:linear-gradient(180deg,#9c27b0,#673ab7)}
    .fab .b-refresh{background:linear-gradient(180deg,#ff7a73,#e53935)}

    /* ===== Mobile: pulsanti più piccoli e compatti ===== */
    @media (max-width: 768px){
      .fab{right:12px;bottom:calc(20px + var(--safe-area-bottom));top:auto;gap:10px}
      
      /* I controlli zoom sono ora posizionati in basso a sinistra */
      .fab button{width:52px;height:52px;border-radius:16px;box-shadow:0 6px 16px rgba(0,0,0,0.3);touch-action:manipulation}
      .fab svg.icon-stroke{width:22px;height:22px}

      /* Nascondi controlli zoom su mobile - si usa il touch per zoomare */
      .leaflet-control-zoom{
        display:none!important;
      }
      .leaflet-control-zoom a{
        width:56px!important;
        height:56px!important;
        line-height:56px!important;
        font-size:24px!important;
        font-weight:700!important;
        touch-action:manipulation!important;
        background:transparent!important;
        border:none!important;
        color:#2c3e50!important;
        transition:all 0.3s cubic-bezier(0.4,0,0.2,1)!important;
        display:flex!important;
        align-items:center!important;
        justify-content:center!important;
      }
      .leaflet-control-zoom a:hover{
        background:rgba(30,136,229,0.1)!important;
        color:#1e88e5!important;
        transform:scale(1.05)!important;
      }
      .leaflet-control-zoom a:active{
        transform:scale(0.95)!important;
        background:rgba(30,136,229,0.2)!important;
      }
      .leaflet-control-zoom-in{
        border-bottom:1px solid rgba(0,0,0,0.1)!important;
      }

      /* Marker più grandi per touch */
      .leaflet-marker-icon{transform:scale(1.3)!important}

      /* Toast mobile con safe area */
      .toast{left:16px;right:16px;transform:none;bottom:calc(20px + var(--safe-area-bottom));font-size:14px;z-index:2000}

      /* Popup più grandi su mobile */
      .leaflet-popup-content{font-size:14px;min-width:240px}

      
    }

    .fab-panel{position:fixed;right:72px; top:60px; display:none; z-index:901}
      .fab-panel[data-open="true"]{display:block}
      .fab-card{background:var(--panel);border:1px solid var(--bd);border-radius:18px;box-shadow:0 16px 40px rgba(0,0,0,0.2);padding:12px;backdrop-filter:blur(12px);min-width:280px}
      .layer-item{display:flex;align-items:center;gap:14px;padding:12px 16px;border-radius:14px;cursor:pointer;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);position:relative;overflow:hidden;margin-bottom:6px}
      .layer-item::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent,rgba(255,255,255,0.1));opacity:0;transition:opacity 0.3s ease;pointer-events:none}
      .layer-item:hover{background:linear-gradient(135deg,rgba(30,136,229,0.08),rgba(67,163,255,0.08));transform:translateY(-2px);box-shadow:0 8px 24px rgba(30,136,229,0.15)}
      .layer-item:hover::before{opacity:1}
      .layer-item:active{transform:translateY(0);transition:transform 0.1s ease}
      .layer-swatch{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;font-size:16px;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,0.3);box-shadow:0 4px 12px rgba(0,0,0,0.15);position:relative;overflow:hidden}
      .layer-swatch::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,0.3),transparent 70%);pointer-events:none}
      .layer-content{flex:1;display:flex;flex-direction:column;gap:2px}
      .layer-title{font-weight:700;font-size:15px;color:var(--text);letter-spacing:0.3px}
      .layer-sub{font-size:12px;color:var(--muted);font-weight:500;opacity:0.8}
      .layer-item[data-active="true"]{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#fff;box-shadow:0 8px 24px rgba(30,136,229,0.4)}
      .layer-item[data-active="true"] .layer-title{color:#fff}
      .layer-item[data-active="true"] .layer-sub{color:rgba(255,255,255,0.9)}
      .layer-item[data-active="true"]::after{content:'✓';position:absolute;right:16px;top:50%;transform:translateY(-50%);font-size:18px;font-weight:bold;color:#fff}

    .modal{position:fixed;inset:0;display:none;z-index:1400;padding:var(--safe-area-top) var(--safe-area-right) var(--safe-area-bottom) var(--safe-area-left)}
    .modal[data-open="true"]{display:flex;align-items:center;justify-content:center}
    .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.35)}
    .sheet{position:relative;background:#fff;border:1px solid #e6edf5;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);width:min(980px,94vw);max-height:calc(90vh - var(--safe-area-top) - var(--safe-area-bottom));max-height:calc(90dvh - var(--safe-area-top) - var(--safe-area-bottom));display:flex;flex-direction:column;margin:0 auto;transform:translateY(0);transition:transform 0.3s ease}
    .sheet .header{position:sticky;top:0;background:#fff;z-index:2;padding:18px 18px 8px;border-bottom:1px solid #eef3f8;border-top-left-radius:16px;border-top-right-radius:16px}
    .sheet .close{position:absolute;right:12px;top:12px;width:36px;height:36px;border-radius:10px;border:none;background:transparent;cursor:pointer}
    .sheet .close:hover{background:#f5f7fb}
    .sheet-body{padding:12px 18px 6px;overflow:auto}
    .btn{appearance:none;border:none;cursor:pointer;height:44px;border-radius:10px;padding:0 14px;font-weight:700}
    .btn.primary{background:#1e88e5;color:#fff}
    .btn.ghost{background:#fff;border:1px solid #d8e2ee;color:#0e1621}
    .btn.save{background:#0ea5e9;color:#fff}
    .modal-footer{position:sticky;bottom:0;background:#fff;border-top:1px solid #eef3f8;padding:10px 12px;border-bottom-left-radius:16px;border-bottom-right-radius:16px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    @media (max-width: 560px){.modal-footer{flex-direction:column;align-items:stretch}.btn{width:100%}}

    .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin:8px 0 6px}
    @media (max-width: 860px){.cards{grid-template-columns:1fr 1fr}}
    .card{background:#fff;border:1px solid #e7edf6;border-radius:14px;padding:14px 12px;box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .card h4{margin:0 0 6px;font-size:12px;color:#6b7f95;font-weight:700}
    .card .value{font-size:28px;font-weight:800}
    .v-blue{color:#1e88e5}.v-red{color:#e53935}.v-green{color:#10b981}.v-orange{color:#ef6c00}
    .panel{background:#fff;border:1px solid #e7edf6;border-radius:14px;padding:14px 12px;box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .hotspots{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:10px}
    @media (max-width: 980px){.hotspots{grid-template-columns:1fr}}
    .hot{border:1px solid #e7edf6;background:#fff;border-radius:12px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center}
    .hot .left{display:flex;flex-direction:column}
    .badge{background:#ff7a73;color:#fff;border-radius:999px;padding:4px 8px;font-weight:700}

    /* ====== UI Omogenea Filtri ====== */
    .field{display:flex;flex-direction:column;gap:6px}
    .label{font-size:12px;color:#5b6f86;font-weight:700}
    .input,.select{height:42px;border-radius:12px;border:1px solid #d8e2ee;background:#f9fbff;padding:0 12px;outline:none;box-shadow:inset 0 1px 0 rgba(255,255,255,.8)}
    .input::placeholder{color:#8aa0b7}
    .input:focus,.select:focus{border-color:#88b6ff;box-shadow:0 0 0 3px rgba(30,136,229,.15)}
    .hint{font-size:12px;color:#6c829b}
    .pill{background:#f1f5fa;border:1px solid #d8e2ee;color:#42586e}

    input[type="range"]{appearance:none;width:100%;height:6px;border-radius:999px;background:#e7eef8;outline:none}
    input[type="range"]::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:#1e88e5;border:2px solid #fff;box-shadow:0 4px 8px rgba(30,136,229,.35);cursor:pointer;margin-top:-6px}
    input[type="range"]::-moz-range-thumb{width:18px;height:18px;border:none;border-radius:50%;background:#1e88e5;box-shadow:0 4px 8px rgba(30,136,229,.35);cursor:pointer}
    input[type="range"]::-webkit-slider-runnable-track{height:6px;border-radius:999px;background:#e7eef8}
    input[type="range"]::-moz-range-track{height:6px;border-radius:999px;background:#e7eef8}

    .preview{background:linear-gradient(0deg,#f7fbff,#edf4ff);border:1px solid #dbeff;border-radius:14px}
    .metric .big{line-height:1}

    /* ====== Mobile: modale più compatta ====== */
    @media (max-width: 768px){
      .modal{padding:calc(10px + var(--safe-area-top)) calc(10px + var(--safe-area-right)) calc(10px + var(--safe-area-bottom)) calc(10px + var(--safe-area-left))}
      .modal[data-open="true"]{align-items:center;justify-content:center;padding:10px}
      .sheet{width:calc(100vw - 20px);border-radius:12px;max-height:calc(95vh - var(--safe-area-top) - var(--safe-area-bottom));margin:0 auto;transform:translateY(0)}
      .sheet .header{padding:14px 14px 8px;border-bottom:1px solid #eef3f8}
      .sheet-body{padding:12px 14px;max-height:calc(75vh - var(--safe-area-top) - var(--safe-area-bottom));overflow-y:auto;-webkit-overflow-scrolling:touch}
      .input,.select{height:48px;font-size:16px;touch-action:manipulation;border-radius:8px}
      .btn{height:48px;font-size:16px;touch-action:manipulation;min-width:48px;border-radius:8px}
      .chip{padding:14px 18px;font-size:15px;min-height:48px;touch-action:manipulation;border-radius:12px}
      .close{width:48px!important;height:48px!important;font-size:20px!important;touch-action:manipulation;border-radius:12px}

      /* Cards responsive */
      .cards{grid-template-columns:1fr;gap:12px}
      .hotspots{grid-template-columns:1fr;gap:8px}
      .grid-2{grid-template-columns:1fr!important}
      .grid-3{grid-template-columns:1fr!important}

      /* Footer pulsanti mobile */
      .modal-footer{padding:14px;gap:10px;flex-direction:column;position:sticky;bottom:0}
      .footer-right{display:flex;gap:10px;width:100%}
      .footer-right .btn{flex:1;min-height:48px}
      .footer-left{width:100%}
      .footer-left .btn{width:100%;margin-bottom:10px}
    }

    /* Notifiche Live */
    .notifications{display:flex;flex-direction:column;gap:8px}
    .notification-item{display:flex;align-items:center;gap:8px;padding:8px 10px;background:#f8fcff;border:1px solid #dbe8f4;border-radius:8px;font-size:12px;transition:all 0.3s ease}
    .notification-item:hover{background:#eef6ff;transform:translateY(-1px)}
    .notification-item[data-type="warning"]{background:#fff8f0;border-color:#ffd7a3}
    .notification-item[data-type="error"]{background:#fff5f5;border-color:#ffa8a8}
    .notification-item[data-type="success"]{background:#f0fff4;border-color:#9ae6b4}
    .notification-icon{font-size:14px}
    .notification-text{flex:1;font-weight:500}
    .notification-time{color:var(--muted);font-size:10px}

    /* Miglioramenti chip con hover effects */
    .chip:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
    .chip[data-active="true"]:hover{transform:translateY(-1px)}

    /* Loading spinner */
    .spinner{width:20px;height:20px;border:2px solid #f3f3f3;border-top:2px solid var(--accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

    /* Stile speciale per pulsante navigazione */
    #getDirections:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(30,136,229,0.4)!important}
    #getDirections:active{transform:translateY(0);box-shadow:0 2px 8px rgba(30,136,229,0.3)!important}

    /* Stile speciale per pulsante centra mappa */
    #eventZoom:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(16,185,129,0.4)!important}
    #eventZoom:active{transform:translateY(0);box-shadow:0 2px 8px rgba(16,185,129,0.3)!important}

    /* Effetti hover per pulsanti filtri avanzati */
    #fReset:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(220,53,69,0.4)!important}
    #fReset:active{transform:translateY(0);box-shadow:0 2px 8px rgba(220,53,69,0.3)!important}
    
    #fSave:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(40,167,69,0.4)!important}
    #fSave:active{transform:translateY(0);box-shadow:0 2px 8px rgba(40,167,69,0.3)!important}

    /* Effetti hover per pulsante ripristina default */
    #settingsReset:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(108,117,125,0.4)!important}
    #settingsReset:active{transform:translateY(0);box-shadow:0 2px 8px rgba(108,117,125,0.3)!important}

    /* Effetti hover per pulsante test suono */
    #testSoundBtn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(40,167,69,0.4)!important}
    #testSoundBtn:active{transform:translateY(0);box-shadow:0 2px 8px rgba(40,167,69,0.3)!important}

    /* Stili pulsanti tipo suono */
    .sound-type-btn:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(30,136,229,0.2)!important;border-color:#88b6ff!important}
    .sound-type-btn:active{transform:translateY(0)}
    .sound-type-btn[data-active="true"]{background:linear-gradient(135deg,#1e88e5,#0d47a1)!important;color:#fff!important;border-color:#1e88e5!important;box-shadow:0 4px 12px rgba(30,136,229,0.4)!important}
    .sound-type-btn[data-active="true"]:hover{box-shadow:0 8px 20px rgba(30,136,229,0.5)!important}

    /* Overlay errori runtime */
    #errorOverlay{position:fixed;inset:auto 10px 10px 10px;background:#11161c;color:#f3f7ff;border:1px solid #2b3440;border-radius:10px;padding:10px 12px;box-shadow:0 8px 20px rgba(0,0,0,.35);font-size:12px;z-index:3000;display:none;max-height:40vh;overflow:auto}
    #errorOverlay b{color:#ffb0b0}

    /* Status indicator */
    .status-indicator{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
    .status-online{background:var(--ok);animation:pulse 2s infinite}
    .status-offline{background:var(--err)}
    .status-warning{background:var(--warn)}

    /* Toggle Switch */
    .toggle-switch{position:relative;display:inline-block;width:50px;height:24px}
    .toggle-switch input{opacity:0;width:0;height:0}
    .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;transition:.4s;border-radius:24px}
    .toggle-slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background:#fff;transition:.4s;border-radius:50%}
    input:checked + .toggle-slider{background:var(--accent)}
    input:checked + .toggle-slider:before{transform:translateX(26px)}

    /* Controlli zoom per desktop - visibili e posizionati normalmente */
    @media (min-width: 769px){
      .leaflet-control-zoom{
        display:block!important;
        margin-top:16px!important;
        margin-left:16px!important;
        border-radius:12px!important;
        box-shadow:0 6px 20px rgba(0,0,0,0.15)!important;
        overflow:hidden!important;
        background:rgba(255,255,255,0.95)!important;
        backdrop-filter:blur(10px)!important;
        border:1px solid rgba(255,255,255,0.6)!important;
      }
      .leaflet-control-zoom a{
        width:40px!important;
        height:40px!important;
        line-height:40px!important;
        font-size:18px!important;
        font-weight:600!important;
        background:transparent!important;
        border:none!important;
        color:#2c3e50!important;
        transition:all 0.2s ease!important;
        display:flex!important;
        align-items:center!important;
        justify-content:center!important;
      }
      .leaflet-control-zoom a:hover{
        background:rgba(30,136,229,0.1)!important;
        color:#1e88e5!important;
        transform:scale(1.05)!important;
      }
      .leaflet-control-zoom a:active{
        transform:scale(0.95)!important;
        background:rgba(30,136,229,0.2)!important;
      }
      .leaflet-control-zoom-in{
        border-bottom:1px solid rgba(0,0,0,0.1)!important;
      }
    }

    /* Tema Scuro */
    [data-theme="dark"]{
      --bg:#1a1d23;
      --panel:#242831;
      --panel-2:#2a2d36;
      --text:#e2e8f0;
      --muted:#94a3b8;
      --accent:#3b82f6;
      --accent-2:#60a5fa;
      --ok:#10b981;
      --warn:#f59e0b;
      --err:#ef4444;
      --chip:#374151;
      --chip-border:#4b5563;
      --shadow:0 14px 28px rgba(0,0,0,.4);
      --bd:#374151;
      --gradient-primary:linear-gradient(135deg,#1e3a8a 0%,#3730a3 100%);
      --gradient-secondary:linear-gradient(135deg,#be185d 0%,#be123c 100%);
    }

    [data-theme="dark"] .input, [data-theme="dark"] .select{
      background:#374151;
      border-color:#4b5563;
      color:#e2e8f0;
    }

    [data-theme="dark"] .input::placeholder{
      color:#6b7280;
    }

    [data-theme="dark"] .chip{
      background:#374151;
      border-color:#4b5563;
      color:#d1d5db;
    }

    [data-theme="dark"] .toggle-slider{
      background:#4b5563;
    }
  </style>
</head>
<body class="splash-active">
  <!-- SPLASH SCREEN CINEMATOGRAFICO -->
  <div id="splash-screen">
    <div class="particles"></div>
    
    <div class="splash-logo">
      <img src="attached_assets/logo3d-1024x1024_1754913410278.png" alt="POWERINGUASTI Logo 3D" />
    </div>
    
    <div class="splash-title">POWERGUASTI</div>
    <div class="splash-subtitle">Sistema Avanzato di Monitoraggio Elettrico</div>
    
    <div class="loading-container">
      <div class="loading-bar"></div>
    </div>
    <div class="loading-text">Inizializzazione sistema...</div>
  </div>

  <div class="app">
    <header>
      <div class="logo" aria-label="logo">
        <img src="attached_assets/logo3d-1024x1024_1754913410278.png" 
             alt="POWERINGUASTI Logo" 
             style="width: 72px; height: 72px; object-fit: contain; display: block;">
      </div>
    </header>

    <aside class="sidebar" id="sidebar">
      <div class="section">
        <h3>Filtro rapido</h3>
        <div class="row" id="causeChips">
          <div class="chip" data-value="all" data-active="true">Tutto</div>
          <div class="chip" data-value="Guasto">Guasti</div>
          <div class="chip" data-value="Lavoro Programmato">Lavori Programmati</div>
        </div>
      </div>
      <div class="section">
        <h3>Area</h3>
        <div class="row">
          <button class="chip" id="fitCalabria">📌 Centra Calabria</button>
          <button class="chip" id="fitItaly">🇮🇹 Centra Italia</button>
        </div>
      </div>
      <div class="section">
        <h3>Legenda</h3>
        <div class="legend">
          <span class="sw" style="background:var(--err);width:10px;height:10px;border-radius:50%"></span><span>Guasto</span>
          <span class="sw" style="background:var(--warn);width:10px;height:10px;border-radius:50%"></span><span>Lavoro programmato</span>
        </div>
      </div>
      <div class="section">
        <h3>Notifiche Live</h3>
        <div id="notifications" class="notifications">
          <div class="notification-item animate-fade" data-type="info">
            <span class="notification-icon">ℹ️</span>
            <span class="notification-text">Sistema monitoraggio attivo</span>
            <span class="notification-time" id="currentTime"></span>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>Diagnostica</h3>
        <div id="tests" class="tests"></div>
      </div>
    </aside>

    <main id="map"></main>
  </div>

  <div class="fab" aria-label="toolbar">
    <button class="b-filter" id="fabFilter" title="Filtri Avanzati">
      <svg class="icon-stroke" viewBox="0 0 24 24"><path d="M3 5h18"/><path d="M6 12h12"/><path d="M10 19h4"/></svg>
    </button>
    <button class="b-analytics" id="fabAnalytics" title="Statistiche">
      <svg class="icon-stroke" viewBox="0 0 24 24"><path d="M5 20V10"/><path d="M12 20V4"/><path d="M19 20v-7"/></svg>
    </button>
    <button class="b-layers" id="fabLayers" title="Layer mappa">
      <svg class="icon-stroke" viewBox="0 0 24 24"><path d="M12 3l9 5-9 5-9-5 9-5Z"/><path d="M21 12l-9 5-9-5"/><path d="M21 16l-9 5-9-5"/></svg>
    </button>
    <button class="b-settings" id="fabSettings" title="Impostazioni">
      <svg class="icon-stroke" viewBox="0 0 24 24">
        <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
      </svg>
    </button>
    <button class="b-refresh" id="fabRefresh" title="Aggiorna">
      <svg class="icon-stroke" viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-3-6.7"/><path d="M21 3v6h-6"/></svg>
    </button>
  </div>

  <div class="modal" id="layersModal" aria-hidden="true">
    <div class="backdrop" id="layersBackdrop"></div>
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="layersTitle">
      <div class="header">
        <button class="close" id="layersClose" title="Chiudi" aria-label="Chiudi">
          <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#667a8f" d="M18.3 5.7 12 12l6.3 6.3-1.4 1.4L10.6 13.4 4.3 19.7 2.9 18.3 9.2 12 2.9 5.7 4.3 4.3l6.3 6.3 6.3-6.3z"/></svg>
        </button>
        <h2 id="layersTitle" style="display:flex;align-items:center;gap:8px;margin:0">
          <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#2a3f55" d="M12 3l9 5-9 5-9-5 9-5Z"/><path fill="#2a3f55" d="M21 12l-9 5-9-5"/><path fill="#2a3f55" d="M21 16l-9 5-9-5"/></svg>
          Selezione Mappa Base
        </h2>
      </div>
      <div class="sheet-body">
        <div style="margin-bottom:16px">
          <h4 style="margin:0 0 12px;color:#2a3f55;display:flex;align-items:center;gap:8px">
            <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#2a3f55" d="M3 4h18v2H3zm0 7h18v2H3zm0 7h18v2H3z"/></svg>
            Mappe Stradali
          </h4>
          <div class="layer-item" data-layer="positron">
            <div class="layer-swatch" style="background:linear-gradient(135deg,#f7f7f7,#e7e7e7)">🗺️</div>
            <div class="layer-content">
              <div class="layer-title">Stradale Chiara</div>
              <div class="layer-sub">CartoDB Positron - Ottima per la visualizzazione dati</div>
            </div>
          </div>
          <div class="layer-item" data-layer="osm">
            <div class="layer-swatch" style="background:linear-gradient(135deg,#d9ecff,#bcd7ff)">🌍</div>
            <div class="layer-content">
              <div class="layer-title">OpenStreetMap</div>
              <div class="layer-sub">Mappa collaborativa globale - Dettagli completi</div>
            </div>
          </div>
          <div class="layer-item" data-layer="dark">
            <div class="layer-swatch" style="background:linear-gradient(135deg,#2c3e50,#34495e)">🌙</div>
            <div class="layer-content">
              <div class="layer-title">Stradale Scura</div>
              <div class="layer-sub">CartoDB Dark Matter - Ideale per la notte</div>
            </div>
          </div>
        </div>

        <div style="margin-bottom:16px">
          <h4 style="margin:0 0 12px;color:#2a3f55;display:flex;align-items:center;gap:8px">
            <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#2a3f55" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
            Mappe Satellitari
          </h4>
          <div class="layer-item" data-layer="sat">
            <div class="layer-swatch" style="background:linear-gradient(135deg,#20304a,#556b7d)">🛰️</div>
            <div class="layer-content">
              <div class="layer-title">Satellite</div>
              <div class="layer-sub">Esri World Imagery - Immagini aeree ad alta risoluzione</div>
            </div>
          </div>
          <div class="layer-item" data-layer="hybrid">
            <div class="layer-swatch" style="background:linear-gradient(135deg,#27ae60,#2ecc71)">🗺️</div>
            <div class="layer-content">
              <div class="layer-title">Ibrida</div>
              <div class="layer-sub">Satellite + Etichette stradali</div>
            </div>
          </div>
        </div>

        <div>
          <h4 style="margin:0 0 12px;color:#2a3f55;display:flex;align-items:center;gap:8px">
            <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#2a3f55" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
            Mappe Specializzate
          </h4>
          <div class="layer-item" data-layer="terrain">
            <div class="layer-swatch" style="background:linear-gradient(135deg,#8b4513,#d2691e)">⛰️</div>
            <div class="layer-content">
              <div class="layer-title">Terreno</div>
              <div class="layer-sub">Rilievi topografici e altimetria</div>
            </div>
          </div>
          <div class="layer-item" data-layer="watercolor">
            <div class="layer-swatch" style="background:linear-gradient(135deg,#e74c3c,#f39c12)">🎨</div>
            <div class="layer-content">
              <div class="layer-title">Watercolor</div>
              <div class="layer-sub">Stamen Watercolor - Stile artistico</div>
            </div>
          </div>
        </div>

        <div style="background:#f8fcff;border:1px solid #dbe8f4;border-radius:12px;padding:12px;margin-top:16px">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <span style="font-size:16px">💡</span>
            <div style="font-weight:600;color:#2a3f55">Suggerimento</div>
          </div>
          <div style="font-size:12px;color:#4e7bb5;line-height:1.4">
            <strong>Stradale Chiara:</strong> Migliore per visualizzare i guasti elettrici con contrasto ottimale<br>
            <strong>Satellite:</strong> Utile per identificare zone geografiche e punti di riferimento<br>
            <strong>Scura:</strong> Riduce l'affaticamento visivo durante l'uso notturno
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-left">
          <div style="font-size:12px;color:var(--muted)">
            <span class="status-indicator status-online"></span>
            Connessione: Attiva
          </div>
        </div>
        <div class="footer-right" style="display:flex;gap:8px">
          <button class="btn primary" id="layersClose2">Chiudi</button>
        </div>
      </div>
    </div>
  </div></div>

  <div class="modal" id="statsModal" aria-hidden="true">
    <div class="backdrop" id="statsBackdrop"></div>
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="statsTitle">
      <div class="header">
        <button class="close" id="statsClose" title="Chiudi" aria-label="Chiudi">
          <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#667a8f" d="M18.3 5.7 12 12l6.3 6.3-1.4 1.4L10.6 13.4 4.3 19.7 2.9 18.3 9.2 12 2.9 5.7 4.3 4.3l6.3 6.3 6.3-6.3z"/></svg>
        </button>
        <h2 id="statsTitle" style="display:flex;align-items:center;gap:8px;margin:0"><svg width="20" height="20" viewBox="0 0 24 24"><path fill="#2a3f55" d="M3 20h18v-2H3zm4-4h10v-2H7zm-3-4h16V10H4zm-2-4h20V6H2z"/></svg> Dashboard Statistiche</h2>
      </div>
      <div class="sheet-body">
        <div class="cards">
          <div class="card"><h4>Totale Eventi</h4><div class="value v-blue" id="k_totGuasti">0</div></div>
          <div class="card"><h4>Attivi Ora</h4><div class="value v-red" id="k_attivi">0</div></div>
          <div class="card"><h4>Utenti Coinvolti</h4><div class="value v-green" id="k_utenti">0</div></div>
          <div class="card"><h4>Durata Media</h4><div class="value v-orange" id="k_durata">—</div></div>
        </div>
        <h3 style="margin:12px 0 6px">Zone Più Colpite</h3>
        <div class="hotspots" id="hotspotsList"></div>
      </div>
      <div class="modal-footer">
        <div></div>
        <div></div>
      </div>
    </div>
  </div>

  <div class="modal" id="filtersModal" aria-hidden="true">
    <div class="backdrop" id="filtersBackdrop"></div>
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="filtersTitle">
      <div class="header">
        <button class="close" id="filtersClose" title="Chiudi" aria-label="Chiudi">
          <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#667a8f" d="M18.3 5.7 12 12l6.3 6.3-1.4 1.4L10.6 13.4 4.3 19.7 2.9 18.3 9.2 12 2.9 5.7 4.3 4.3l6.3 6.3 6.3-6.3z"/></svg>
        </button>
        <h2 id="filtersTitle" style="display:flex;align-items:center;gap:8px;margin:0"><svg width="20" height="20" viewBox="0 0 24 24"><path fill="#2a3f55" d="M3 5h18v2H3zm3 7h12v2H6zm4 7h4v2h-4z"/></svg> Filtri Avanzati</h2>
      </div>
      <div class="sheet-body">
        <div class="field" style="margin-bottom:10px">
          <label class="label">🔍 Cerca per Indirizzo/Località</label>
          <input class="input" id="fAddress" placeholder="Es: Roma, Via del Corso, Napoli Centro…" />
          <button class="btn primary" id="geocodeBtn" style="margin-top:6px;height:36px;font-size:12px">Trova sulla mappa</button>
        </div>
        <div class="grid-2" style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div class="field">
            <label class="label">Regione</label>
            <select class="select" id="fRegion">
              <option value="all">Tutte le Regioni</option>
              <option value="Calabria" selected>Calabria</option>
              <option value="Sicilia">Sicilia</option>
              <option value="Puglia">Puglia</option>
              <option value="Campania">Campania</option>
              <option value="Lazio">Lazio</option>
              <option value="Lombardia">Lombardia</option>
              <option value="Piemonte">Piemonte</option>
              <option value="Veneto">Veneto</option>
              <option value="Emilia-Romagna">Emilia-Romagna</option>
              <option value="Toscana">Toscana</option>
              <option value="Liguria">Liguria</option>
              <option value="Marche">Marche</option>
              <option value="Abruzzo">Abruzzo</option>
              <option value="Molise">Molise</option>
              <option value="Basilicata">Basilicata</option>
              <option value="Umbria">Umbria</option>
              <option value="Sardegna">Sardegna</option>
            </select>
          </div>
          <div class="field">
            <label class="label">Tipo di Causa</label>
            <select class="select" id="fCause">
              <option value="all">Tutti i Tipi</option>
              <option value="Guasto">Guasto</option>
              <option value="Lavoro Programmato">Lavoro Programmato</option>
            </select>
          </div>
        </div>
        <div class="field" style="margin-top:12px">
          <label class="label">Utenti Coinvolti (minimo)</label>
          <input type="range" class="input" id="fUsers" min="0" max="1000" value="0" step="10" style="height:auto;padding:0;width:100%">
          <div class="hint" id="fUsersLabel">0 - 10000+</div>
        </div>
        <div class="field" style="margin-top:12px">
          <label class="label">Durata Stimata (minimo)</label>
          <select class="select" id="fDuration">
            <option value="any">Qualsiasi Durata</option>
            <option value="lt1">Meno di 1 ora</option>
            <option value="1to4">1 - 4 ore</option>
            <option value="gt4">Oltre 4 ore</option>
          </select>
        </div>
        <div class="field" style="margin-top:12px">
          <label class="label">Periodo di Riferimento</label>
          <select class="select" id="fPeriod">
            <option value="all">Tutto il Periodo</option>
            <option value="24h">Ultime 24h</option>
            <option value="7d">Ultimi 7 giorni</option>
            <option value="30d">Ultimi 30 giorni</option>
          </select>
        </div>
        <div class="preview" style="background:linear-gradient(0deg,#f3f7ff,#eef4ff);border:1px solid #dbeff;border-radius:14px;padding:12px;margin-top:12px">
          <div class="row" style="display:flex;justify-content:space-between;align-items:center">
            <div style="display:flex;align-items:center;gap:8px;color:#2a3f55;font-weight:700"><svg width="18" height="18" viewBox="0 0 24 24"><path fill="#2a3f55" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg> Anteprima Risultati</div>
            <div class="pill" id="fActiveCount" style="padding:6px 10px;border-radius:999px;background:#f1f5fa;border:1px solid #d8e2ee;color:#42586e;font-size:12px">0 filtri attivi</div>
          </div>
          <div class="row" style="display:flex;justify-content:center;align-items:center;margin-top:8px;gap:20px">
            <div class="metric" style="display:flex;flex-direction:column;align-items:center;gap:4px">
              <div class="big" style="font-weight:800;font-size:32px;color:#1e88e5" id="fFound">0</div>
              <div style="color:#4e7bb5;font-weight:600">Eventi Trovati</div>
              <div class="hint">su <span id="fTotal">0</span> totali</div>
            </div>
            <div class="metric" style="display:flex;flex-direction:column;align-items:center;gap:4px">
              <div class="big" style="font-weight:800;font-size:32px;color:#e53935" id="fAffectedUsers">0</div>
              <div style="color:#4e7bb5;font-weight:600">Utenti Coinvolti</div>
              <div class="hint">nei guasti filtrati</div>
            </div>
          </div>
        </div>
        </div>
      <div class="modal-footer">
        <div class="footer-left" style="display:flex;gap:8px">
          <button class="btn" id="fReset" style="background:linear-gradient(135deg,#dc3545,#c82333);color:#fff;border:none;font-weight:700;box-shadow:0 4px 12px rgba(220,53,69,0.3);transition:all 0.2s ease;">🗑️ Azzera Filtri</button>
          <button class="btn" id="fSave" style="background:linear-gradient(135deg,#28a745,#20692e);color:#fff;border:none;font-weight:700;box-shadow:0 4px 12px rgba(40,167,69,0.3);transition:all 0.2s ease;">💾 Salva Predefiniti</button>
        </div>
        <div class="footer-right" style="display:flex;gap:8px">
          <button class="btn primary" id="fApply">🔍 Applica Filtri</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="calendarModal" aria-hidden="true">
    <div class="backdrop" id="calendarBackdrop"></div>
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="calendarTitle">
      <div class="header">
        <button class="close" id="calendarClose" title="Chiudi" aria-label="Chiudi">
          <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#667a8f" d="M18.3 5.7 12 12l6.3 6.3-1.4 1.4L10.6 13.4 4.3 19.7 2.9 18.3 9.2 12 2.9 5.7 4.3 4.3l6.3 6.3 6.3-6.3z"/></svg>
        </button>
        <h2 id="calendarTitle" style="display:flex;align-items:center;gap:8px;margin:0">📅 Calendario Eventi</h2>
      </div>
      <div class="sheet-body">
        <div style="display:grid;grid-template-columns:1fr 300px;gap:20px">
          <div>
            <div class="calendar-grid" id="calendarGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;background:#f8fbff;padding:10px;border-radius:10px">
              <div style="padding:8px;text-align:center;font-weight:700;color:#666">Dom</div>
              <div style="padding:8px;text-align:center;font-weight:700;color:#666">Lun</div>
              <div style="padding:8px;text-align:center;font-weight:700;color:#666">Mar</div>
              <div style="padding:8px;text-align:center;font-weight:700;color:#666">Mer</div>
              <div style="padding:8px;text-align:center;font-weight:700;color:#666">Gio</div>
              <div style="padding:8px;text-align:center;font-weight:700;color:#666">Ven</div>
              <div style="padding:8px;text-align:center;font-weight:700;color:#666">Sab</div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin:15px 0">
              <button class="btn ghost" id="prevMonth">← Mese Prec.</button>
              <h3 id="currentMonth" style="margin:0;color:#2a3f55">Dicembre 2024</h3>
              <button class="btn ghost" id="nextMonth">Mese Succ. →</button>
            </div>
          </div>
          <div>
            <h4 style="margin:0 0 10px;color:#2a3f55">Eventi del Giorno</h4>
            <div id="dayEvents" style="max-height:300px;overflow:auto">
              <div style="text-align:center;color:#666;padding:20px">Seleziona un giorno</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="eventModal" aria-hidden="true">
    <div class="backdrop" id="eventBackdrop"></div>
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="eventTitle">
      <div class="header">
        <button class="close" id="eventClose" title="Chiudi" aria-label="Chiudi">
          <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#667a8f" d="M18.3 5.7 12 12l6.3 6.3-1.4 1.4L10.6 13.4 4.3 19.7 2.9 18.3 9.2 12 2.9 5.7 4.3 4.3l6.3 6.3 6.3-6.3z"/></svg>
        </button>
        <h2 id="eventTitle" style="display:flex;align-items:center;gap:8px;margin:0">
          <span id="eventIcon">⚡</span>
          <span id="eventLocation">Dettagli Evento</span>
        </h2>
      </div>
      <div class="sheet-body">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
          <div class="card">
            <h4>Tipo di Evento</h4>
            <div class="value" id="eventType" style="font-size:18px;margin-top:5px">—</div>
          </div>
          <div class="card">
            <h4>Stato</h4>
            <div class="value" id="eventStatus" style="font-size:18px;margin-top:5px">—</div>
          </div>
        </div>

        <div class="panel" style="margin-bottom:20px">
          <h4 style="margin:0 0 12px;color:#2a3f55;display:flex;align-items:center;gap:8px">
            <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#2a3f55" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
            Localizzazione Cabina Elettrica
          </h4>
          <div style="display:grid;grid-template-columns:120px 1fr;gap:8px;font-size:14px">
            <div style="color:#566d84;font-weight:600">🏢 Comune</div>
            <div id="eventComune" style="font-weight:700;color:#1e88e5">—</div>
            <div style="color:#566d84;font-weight:600">🏛️ Provincia</div>
            <div id="eventProvincia">—</div>
            <div style="color:#566d84;font-weight:600">📍 Coordinate</div>
            <div id="eventCoordinate">—</div>
          </div>
        </div>

        <div class="panel" style="margin-bottom:20px">
          <h4 style="margin:0 0 12px;color:#2a3f55;display:flex;align-items:center;gap:8px">
            <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#2a3f55" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
            Impatto
          </h4>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
            <div style="text-align:center;padding:15px;background:#f8fcff;border:1px solid #dbe8f4;border-radius:10px">
              <div style="font-size:28px;font-weight:800;color:#1e88e5" id="eventClienti">0</div>
              <div style="color:#4e7bb5;font-weight:600">Utenti Coinvolti</div>
            </div>
            <div style="text-align:center;padding:15px;background:#fff8f0;border:1px solid #ffd7a3;border-radius:10px">
              <div style="font-size:28px;font-weight:800;color:#ef6c00" id="eventDurata">—</div>
              <div style="color:#b5704e;font-weight:600">Durata Stimata</div>
            </div>
          </div>
        </div>

        <div class="panel" style="margin-bottom:20px">
          <h4 style="margin:0 0 12px;color:#2a3f55;display:flex;align-items:center;gap:8px">
            <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#2a3f55" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
            Tempi
          </h4>
          <div style="display:grid;grid-template-columns:140px 1fr;gap:8px;font-size:14px">
            <div style="color:#566d84;font-weight:600">Inizio Guasto</div>
            <div id="eventInizio">—</div>
            <div style="color:#566d84;font-weight:600">Ultimo Aggiornamento</div>
            <div id="eventUltimoAggiornamento">—</div>
            <div style="color:#566d84;font-weight:600">Ripristino Previsto</div>
            <div id="eventRipristinoPrevisto">—</div>
          </div>
        </div>

        <div class="panel" id="eventNote" style="display:none">
          <h4 style="margin:0 0 12px;color:#2a3f55;display:flex;align-items:center;gap:8px">
            <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#2a3f55" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
            Note Aggiuntive
          </h4>
          <div id="eventNoteText" style="background:#f8fbff;border:1px solid #dbe8f4;border-radius:8px;padding:12px;font-size:14px;line-height:1.5"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-left">
          <button class="btn" id="eventZoom" style="background:linear-gradient(135deg,#10b981,#047857);color:#fff;border:none;font-weight:700;box-shadow:0 4px 12px rgba(16,185,129,0.3);transition:all 0.2s ease;">🎯 Centra sulla Mappa</button>
          <button class="btn" id="getDirections" style="background:linear-gradient(135deg,#1e88e5,#0d47a1);color:#fff;border:none;font-weight:700;box-shadow:0 4px 12px rgba(30,136,229,0.3);transition:all 0.2s ease;">🧭 Navigazione</button>
        </div>
        <div class="footer-right" style="display:flex;gap:8px">
          <button class="btn primary" id="eventClose2">Chiudi</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="backdrop" id="settingsBackdrop"></div>
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <div class="header">
        <button class="close" id="settingsClose" title="Chiudi" aria-label="Chiudi">
          <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#667a8f" d="M18.3 5.7 12 12l6.3 6.3-1.4 1.4L10.6 13.4 4.3 19.7 2.9 18.3 9.2 12 2.9 5.7 4.3 4.3l6.3 6.3 6.3-6.3z"/></svg>
        </button>
        <h2 id="settingsTitle" style="display:flex;align-items:center;gap:8px;margin:0">
          <svg width="20" height="20" viewBox="0 0 24 24">
            <path fill="#2a3f55" d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
            <path fill="#2a3f55" d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
          Impostazioni Applicazione
        </h2>
      </div>
      <div class="sheet-body">

        <!-- Sezione Notifiche -->
        <div class="panel" style="margin-bottom:20px">
          <h4 style="margin:0 0 12px;color:#2a3f55;display:flex;align-items:center;gap:8px">
            <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#2a3f55" d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
            Impostazioni Notifiche
          </h4>
          <div style="font-size:12px;color:var(--muted);margin-bottom:15px">Personalizza quando e come ricevere notifiche sui guasti elettrici</div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
            <div>
              <div style="font-weight:600">Abilita Notifiche</div>
              <div style="font-size:12px;color:var(--muted)">Ricevi notifiche automatiche quando vengono rilevati nuovi guasti elettrici</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="settingNotifications" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
            <div>
              <div style="font-weight:600">Solo Calabria</div>
              <div style="font-size:12px;color:var(--muted)">Limita le notifiche solo ai guasti in Calabria. Se disattivato, riceverai notifiche per tutti i guasti della regione selezionata</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="settingOnlyCalabria" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <div>
              <div style="font-weight:600">Notifiche Desktop</div>
              <div style="font-size:12px;color:var(--muted)">Mostra popup di notifica dal sistema operativo</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="settingDesktopNotifications">
              <span class="toggle-slider"></span>
            </label>
          </div>

          <!-- Pulsante per attivare notifiche browser -->
          <div id="notificationPermissionPanel" style="background:#fff3cd;border:1px solid #ffeaa7;border-radius:8px;padding:12px;margin-top:10px;display:none">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
              <span style="font-size:16px">⚠️</span>
              <div style="font-weight:600;color:#856404">Notifiche Non Attive</div>
            </div>
            <div style="font-size:12px;color:#856404;margin-bottom:10px">Attiva le notifiche per essere avvisato dei nuovi guasti in Calabria</div>
            <button class="btn primary" id="requestNotificationPermission" style="width:100%;background:#007bff;border:none;color:white;padding:8px 12px;border-radius:6px;font-weight:600">
              🔔 Attiva Notifiche
            </button>
          </div>
        </div>

        <!-- Sezione Notifiche Sonore -->
        <div class="panel" style="margin-bottom:20px">
          <h4 style="margin:0 0 12px;color:#2a3f55;display:flex;align-items:center;gap:8px">
            <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#2a3f55" d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
            Notifiche Sonore
          </h4>
          <div style="font-size:12px;color:var(--muted);margin-bottom:15px">Configura i suoni di notifica per i guasti elettrici</div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
            <div>
              <div style="font-weight:600">Abilita Suoni</div>
              <div style="font-size:12px;color:var(--muted)">Riproduci suono quando viene rilevato un nuovo guasto</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="settingSounds" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div style="margin-bottom:15px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <div style="font-weight:600">Tipo di Suono</div>
              <button class="btn" id="testSoundBtn" style="background:linear-gradient(135deg,#28a745,#20692e);color:#fff;border:none;font-weight:700;box-shadow:0 4px 12px rgba(40,167,69,0.3);transition:all 0.2s ease;height:36px;padding:0 12px;font-size:14px;">🔊 Test</button>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="sound-type-btn" data-sound="system" style="flex:1;min-height:48px;background:#fff;border:2px solid #d8e2ee;border-radius:12px;padding:8px 12px;display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;transition:all 0.2s ease;font-weight:600;touch-action:manipulation;">
                <span style="font-size:18px">🔔</span>
                <span>Suono Sistema</span>
              </button>
              <button class="sound-type-btn" data-sound="siren" style="flex:1;min-height:48px;background:#fff;border:2px solid #d8e2ee;border-radius:12px;padding:8px 12px;display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;transition:all 0.2s ease;font-weight:600;touch-action:manipulation;">
                <span style="font-size:18px">🚨</span>
                <span>Sirena Allarme</span>
              </button>
            </div>
            <input type="hidden" id="settingSoundType" value="system">
          </div>

          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:600">Volume</div>
              <div id="volumeLabel" style="color:var(--muted);font-size:12px">30%</div>
            </div>
            <input type="range" id="settingVolume" min="0" max="100" value="30" style="width:100%">
          </div>

          <div style="background:#f8fcff;border:1px solid #dbe8f4;border-radius:8px;padding:10px;margin-top:12px;font-size:12px;color:#4e7bb5">
            💡 <strong>Suono Sistema:</strong> Breve tono discreto simile alle notifiche del dispositivo (con vibrazione)<br>
            🚨 <strong>Sirena Emergenza:</strong> Suono intenso di allarme con oscillazioni di frequenza per emergenze reali (2.5 sec + vibrazione forte)
          </div>
        </div>



        <!-- Sezione Stato Sistema -->
        <div class="panel">
          <h4 style="margin:0 0 12px;color:#2a3f55;display:flex;align-items:center;gap:8px">
            <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#2a3f55" d="M13 2.05v3.03c3.39.49 6 3.39 6 6.92 0 .9-.18 1.75-.48 2.54l2.6 1.53c.56-1.24.88-2.62.88-4.07 0-5.18-3.95-9.45-9-9.95zM12 19c-3.87 0-7-3.13-7-7 0-3.53 2.61-6.43 6-6.92V2.05c-5.06.5-9 4.76-9 9.95 0 5.52 4.47 10 9.99 10 3.31 0 6.24-1.61 8.06-4.09l-2.6-1.53C16.17 17.98 14.21 19 12 19z"/></svg>
            Stato Sistema
          </h4>

          <div style="display:grid;grid-template-columns:140px 1fr auto;gap:8px;align-items:center;font-size:14px">
            <div style="color:#566d84;font-weight:600">Notifiche Desktop:</div>
            <div style="font-weight:500">Permessi browser</div>
            <div id="desktopNotificationStatus" style="color:#dc3545;font-weight:600">Non Attive</div>

            <div style="color:#566d84;font-weight:600">Audio:</div>
            <div style="font-weight:500">Supporto sistema</div>
            <div id="audioSupportStatus" style="color:#28a745;font-weight:600">Supportato</div>

            <div style="color:#566d84;font-weight:600">Filtro Calabria:</div>
            <div style="font-weight:500">Geolocalizzazione regionale</div>
            <div id="calabriaFilterStatus" style="color:#007bff;font-weight:600">Attivo</div>
          </div>

          <div style="margin-top:15px;padding:14px;background:#f8f9fa;border:1px solid #e9ecef;border-radius:12px;font-size:13px;color:#495057">
            <div style="margin-bottom:10px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
              <span style="font-size:18px">⚡</span>
              <strong style="color:#007bff;font-size:15px;letter-spacing:0.3px">POWERINGUASTI v1.0</strong>
            </div>
            <div style="margin-bottom:10px;line-height:1.4">
              <strong style="color:#2c3e50;font-size:13px;display:block;margin-bottom:6px">Sistema Avanzato di Monitoraggio Elettrico</strong>
              <span style="color:#6c757d;font-size:12px;line-height:1.3">Piattaforma GIS per il monitoraggio real-time delle interruzioni di servizio elettrico con aggiornamento automatico e notifiche push</span>
            </div>
            <div style="border-top:1px solid #dee2e6;padding-top:10px;margin-top:10px">
              <div style="margin-bottom:8px">
                <strong style="color:#2c3e50;font-size:12px;display:block;margin-bottom:4px">Sviluppatore:</strong>
                <div style="font-size:12px;line-height:1.3">
                  <span style="color:#007bff;font-weight:600">Younes El Mabtouti</span><br>
                  <span style="color:#6c757d">in collaborazione con </span>
                  <span style="color:#007bff;font-weight:600">Matteo Orsetti</span>
                </div>
              </div>
              <div style="margin-bottom:8px">
                <strong style="color:#2c3e50;font-size:12px;display:block;margin-bottom:4px">Stack Tecnologico:</strong>
                <span style="color:#28a745;font-weight:500;font-size:12px;line-height:1.3">JavaScript ES6+, Leaflet.js, OpenStreetMap API, OSRM Routing</span>
              </div>
              <div>
                <strong style="color:#2c3e50;font-size:12px;display:block;margin-bottom:4px">Deployment:</strong>
                <span style="color:#6f42c1;font-weight:500;font-size:12px;line-height:1.3">Progressive Web App, Cross-Platform Mobile, Native APK</span>
              </div>
            </div>
          </div>
        </div>





      </div>
      <div class="modal-footer">
        <div class="footer-left">
          <button class="btn" id="settingsReset" style="background:linear-gradient(135deg,#6c757d,#495057);color:#fff;border:none;font-weight:700;box-shadow:0 4px 12px rgba(108,117,125,0.3);transition:all 0.2s ease;">🔄 Ripristina Default</button>
        </div>
        <div class="footer-right" style="display:flex;gap:8px">
          <button class="btn save" id="settingsSave">💾 Salva Impostazioni</button>
          <button class="btn primary" id="settingsClose2">Chiudi</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Aggiornato</div>
  <div id="errorOverlay"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous" defer></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js" defer></script>
  <script>
  // ===== SPLASH SCREEN CONTROLLER =====
  (function initSplashScreen() {
    const splashScreen = document.getElementById('splash-screen');
    const particlesContainer = document.querySelector('.particles');
    const loadingText = document.querySelector('.loading-text');
    
    // Messaggi di caricamento cinematografici
    const loadingMessages = [
      'Inizializzazione sistema...',
      'Connessione ai server Enel...',
      'Caricamento mappa interattiva...',
      'Configurazione notifiche...',
      'Sincronizzazione dati real-time...',
      'Ottimizzazione per mobile...',
      'Sistema pronto!'
    ];
    
    let messageIndex = 0;
    
    // Crea particelle elettriche animate
    function createParticles() {
      for (let i = 0; i < 25; i++) {
        setTimeout(() => {
          const particle = document.createElement('div');
          particle.className = 'particle';
          particle.style.left = Math.random() * 100 + 'vw';
          particle.style.animationDelay = Math.random() * 6 + 's';
          particle.style.animationDuration = (4 + Math.random() * 4) + 's';
          particlesContainer.appendChild(particle);
          
          // Rimuovi particella dopo l'animazione
          setTimeout(() => {
            if (particle.parentNode) {
              particle.parentNode.removeChild(particle);
            }
          }, 8000);
        }, i * 200);
      }
    }
    
    // Aggiorna testo di caricamento
    function updateLoadingText() {
      if (messageIndex < loadingMessages.length) {
        loadingText.textContent = loadingMessages[messageIndex];
        messageIndex++;
        
        if (messageIndex < loadingMessages.length) {
          setTimeout(updateLoadingText, 800);
        }
      }
    }
    
    // Nasconde lo splash screen con effetto cinematografico
    function hideSplashScreen() {
      splashScreen.classList.add('fade-out');
      
      // Rimuovi la classe splash-active immediatamente per mostrare l'app
      document.body.classList.remove('splash-active');
      
      setTimeout(() => {
        if (splashScreen && splashScreen.parentNode) {
          splashScreen.parentNode.removeChild(splashScreen);
        }
      }, 1000);
      
      // Forza il refresh della mappa dopo che l'app è visibile
      setTimeout(() => {
        if (window.map && typeof window.map.invalidateSize === 'function') {
          window.map.invalidateSize();
          // Mantieni la vista Italia dopo che la mappa è completamente visibile
          window.map.setView([42.5, 12.5], 6);
        }
      }, 1200);
    }
    
    // Inizializza splash screen
    function startSplash() {
      createParticles();
      
      // Continua a creare particelle durante lo splash
      const particleInterval = setInterval(() => {
        if (document.getElementById('splash-screen')) {
          createParticles();
        } else {
          clearInterval(particleInterval);
        }
      }, 3000);
      
      // Inizia aggiornamento testo dopo 3 secondi
      setTimeout(updateLoadingText, 3000);
      
      // Nasconde splash dopo 6 secondi
      setTimeout(hideSplashScreen, 6000);
      
      // Fallback di sicurezza: rimuovi splash dopo 8 secondi anche se qualcosa va storto
      setTimeout(() => {
        document.body.classList.remove('splash-active');
        const splash = document.getElementById('splash-screen');
        if (splash && splash.parentNode) {
          splash.style.display = 'none';
        }
      }, 8000);
    }
    
    // Avvia splash screen
    startSplash();
  })();

  (function initAppWhenLeafletReady(){
    // Overlay errori runtime
    const errorBox = document.getElementById('errorOverlay');
    window.addEventListener('error', (e)=>{
      if(!errorBox) return; errorBox.style.display='block'; errorBox.innerHTML = `<b>Errore:</b> ${e.message}<br><small>${(e.filename||'')}:${e.lineno||''}</small>`;
    });
    window.addEventListener('unhandledrejection', (e)=>{
      if(!errorBox) return; errorBox.style.display='block'; const msg = (e.reason&&e.reason.message) ? e.reason.message : String(e.reason); errorBox.innerHTML = `<b>Promise:</b> ${msg}`;
    });

    function runApp(){
      const FEATURE_SERVER = 'https://ineuportalgis.enel.com/server/rest/services/Hosted/ITA_power_cut_map_layer_View/FeatureServer/0/query';
      window.lastFeatures = window.lastFeatures || [];

      // ======= IMPOSTAZIONI - DICHIARAZIONI GLOBALI ALL'INIZIO =======
      const defaultSettings = {
        notifications: true,
        onlyCalabria: true,
        desktopNotifications: false,
        sounds: true,
        soundType: 'system',
        volume: 30
      };

      let currentSettings = { ...defaultSettings };

      // ======= FUNZIONI DI UPDATE STATUS - DICHIARATE ALL'INIZIO =======
      function updateNotificationStatus() {
        const permissionPanel = document.getElementById('notificationPermissionPanel');
        const statusEl = document.getElementById('desktopNotificationStatus');

        if (!permissionPanel || !statusEl) return;

        // Check if Notification API is available
        if (!('Notification' in window)) {
          permissionPanel.style.display = 'none';
          statusEl.textContent = 'Non Supportate';
          statusEl.style.color = '#dc3545';
          return;
        }

        const permission = Notification.permission;

        switch (permission) {
          case 'granted':
            permissionPanel.style.display = 'none';
            statusEl.textContent = 'Attive';
            statusEl.style.color = '#28a745';
            break;
          case 'denied':
            permissionPanel.style.display = 'block';
            statusEl.textContent = 'Negate';
            statusEl.style.color = '#dc3545';
            break;
          default:
            permissionPanel.style.display = 'block';
            statusEl.textContent = 'Da Attivare';
            statusEl.style.color = '#ffc107';
        }
      }

      function updateSystemStatus() {
        const audioStatusEl = document.getElementById('audioSupportStatus');
        if (audioStatusEl) {
          const hasAudio = 'AudioContext' in window || 'webkitAudioContext' in window;
          audioStatusEl.textContent = hasAudio ? 'Supportato' : 'Non Supportato';
          audioStatusEl.style.color = hasAudio ? '#28a745' : '#dc3545';
        }

        const calabriaStatusEl = document.getElementById('calabriaFilterStatus');
        if (calabriaStatusEl) {
          calabriaStatusEl.textContent = currentSettings.onlyCalabria ? 'Attivo' : 'Disattivo';
          calabriaStatusEl.style.color = currentSettings.onlyCalabria ? '#007bff' : '#6c757d';
        }

        updateNotificationStatus();
      }

      function loadSettings() {
        try {
          const saved = localStorage.getItem('poweringuasti_settings');
          if (saved) {
            currentSettings = { ...defaultSettings, ...JSON.parse(saved) };
          }
        } catch (e) {
          console.warn('Impossibile caricare impostazioni:', e);
          currentSettings = { ...defaultSettings };
        }

        const notificationsEl = document.getElementById('settingNotifications');
        if (notificationsEl) notificationsEl.checked = currentSettings.notifications;

        const onlyCalabriaEl = document.getElementById('settingOnlyCalabria');
        if (onlyCalabriaEl) onlyCalabriaEl.checked = currentSettings.onlyCalabria;

        const desktopNotificationsEl = document.getElementById('settingDesktopNotifications');
        if (desktopNotificationsEl) desktopNotificationsEl.checked = currentSettings.desktopNotifications;

        const soundsEl = document.getElementById('settingSounds');
        if (soundsEl) soundsEl.checked = currentSettings.sounds;

        const soundTypeEl = document.getElementById('settingSoundType');
        if (soundTypeEl) soundTypeEl.value = currentSettings.soundType;

        // Aggiorna pulsanti tipo suono
        document.querySelectorAll('.sound-type-btn').forEach(btn => {
          if (btn.dataset.sound === currentSettings.soundType) {
            btn.setAttribute('data-active', 'true');
          } else {
            btn.removeAttribute('data-active');
          }
        });

        const volumeEl = document.getElementById('settingVolume');
        if (volumeEl) volumeEl.value = currentSettings.volume;

        const volumeLabelEl = document.getElementById('volumeLabel');
        if (volumeLabelEl) volumeLabelEl.textContent = currentSettings.volume + '%';

        updateNotificationStatus();
        updateSystemStatus();
      }

      function saveSettings() {
        const notificationsEl = document.getElementById('settingNotifications');
        if (notificationsEl) currentSettings.notifications = notificationsEl.checked;

        const onlyCalabriaEl = document.getElementById('settingOnlyCalabria');
        if (onlyCalabriaEl) currentSettings.onlyCalabria = onlyCalabriaEl.checked;

        const desktopNotificationsEl = document.getElementById('settingDesktopNotifications');
        if (desktopNotificationsEl) currentSettings.desktopNotifications = desktopNotificationsEl.checked;

        const soundsEl = document.getElementById('settingSounds');
        if (soundsEl) currentSettings.sounds = soundsEl.checked;

        const soundTypeEl = document.getElementById('settingSoundType');
        if (soundTypeEl) currentSettings.soundType = soundTypeEl.value;

        const volumeEl = document.getElementById('settingVolume');
        if (volumeEl) currentSettings.volume = parseInt(volumeEl.value);

        try {
          localStorage.setItem('poweringuasti_settings', JSON.stringify(currentSettings));
          const volumeLabelEl = document.getElementById('volumeLabel');
          if (volumeLabelEl) volumeLabelEl.textContent = currentSettings.volume + '%';
          notifications.add('success', 'Impostazioni salvate con successo');
        } catch (e) {
          notifications.add('error', 'Errore nel salvataggio delle impostazioni');
        }
      }

      function resetSettings() {
        currentSettings = { ...defaultSettings };
        loadSettings();
        try {
          localStorage.removeItem('poweringuasti_settings');
          notifications.add('info', 'Impostazioni ripristinate ai valori predefiniti');
        } catch (e) {
          notifications.add('warning', 'Errore nel ripristino delle impostazioni');
        }
      }

      const baseLayers = {
        positron: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { 
          attribution: '',
          maxZoom: 19
        }),
        osm: L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { 
          attribution: '',
          maxZoom: 19
        }),
        dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { 
          attribution: '',
          maxZoom: 19
        }),
        sat: L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { 
          attribution: '',
          maxZoom: 18
        }),
        hybrid: L.layerGroup([
          L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { 
            attribution: '',
            maxZoom: 18
          }),
          L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', { 
            attribution: '',
            maxZoom: 19
          })
        ]),
        terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { 
          attribution: '',
          maxZoom: 16
        }),
        watercolor: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', { 
          attribution: '',
          maxZoom: 16
        })
      };

      const REGION_BBOX = {
        'Tutta Italia': [[35.3,6.6],[47.2,18.8]],
        'Calabria': [[37.9,15.5],[39.8,17.4]],
        'Sicilia': [[36.4,12.2],[38.9,15.7]],
        'Puglia': [[39.6,15.1],[42.1,18.6]],
        'Campania': [[40.0,13.6],[41.6,15.7]],
        'Lazio': [[41.0,11.0],[42.8,13.8]],
        'Lombardia': [[45.0,8.0],[46.8,10.7]],
        'Piemonte': [[44.0,6.5],[46.8,9.5]],
        'Veneto': [[45.0,10.5],[46.8,13.2]],
        'Emilia-Romagna': [[43.7,9.1],[45.2,12.9]],
        'Toscana': [[42.2,9.6],[44.5,11.9]],
        'Liguria': [[43.6,7.4],[44.7,10.1]],
        'Marche': [[42.8,12.1],[44.7,13.8]],
        'Abruzzo': [[41.6,13.0],[42.9,14.7]],
        'Molise': [[41.4,14.3],[42.1,15.1]],
        'Basilicata': [[39.7,15.4],[41.3,16.9]],
        'Umbria': [[42.7,11.8],[43.6,13.3]],
        'Trentino-Alto Adige': [[45.5,10.3],[47.1,12.5]],
        'Friuli-Venezia Giulia': [[45.5,12.3],[46.7,13.9]],
        'Sardegna': [[38.8,8.0],[41.3,9.9]],
        'Valle d\'Aosta': [[45.5,6.8],[46.1,7.7]],
        'Provincia Autonoma di Bolzano': [[46.2,10.3],[47.1,12.5]],
        'Provincia Autonoma di Trento': [[45.8,10.3],[46.5,11.9]]
      };

      const toast = (msg) => { const el = document.getElementById('toast'); if(!el) return; el.textContent = msg; el.setAttribute('data-show','true'); setTimeout(()=>el.removeAttribute('data-show'), 1600); };
      const testsEl = () => document.getElementById('tests');
      function addTest(name, ok, note=''){ const d = document.createElement('div'); d.className = 'chip ' + (ok ? 'pass' : 'fail'); d.textContent = (ok ? '✓ ' : '✗ ') + name + (note ? ' — ' + note : ''); testsEl()?.appendChild(d); }
      function pickAttr(attrs, candidates){ if(!attrs) return undefined; const low = {}; for(const k in attrs){ low[k.toLowerCase()] = attrs[k]; } for(const c of candidates){ const v = low[c.toLowerCase()]; if(v !== undefined && v !== null && v !== '') return v; } return undefined; }

      // ========= DEMO & JSONP =========
      function demoFeatures(){
        const now = Date.now();
        const base = (lat,lon,cause,utenti,comune,prov) => ({
          geometry:{ x: lon, y: lat },
          attributes:{
            causa_disalimentazione: cause,
            num_cli_disalim: utenti,
            comune: comune,
            provincia: prov,
            data_interruzione: now - 2*3600*1000, // Mappato da data_inizio
            data_prev_ripristino: now + 1*3600*1000, // Mappato da data_fine_prevista
            dataultimoaggiornamento: now // Mappato da data_inizio o simile
          }
        });
        return [
          base(38.910,16.589,'Guasto',120,'Cosenza','CS'),
          base(38.110,15.650,'Lavoro Programmato',60,'Reggio di Calabria','RC'),
          base(39.000,17.120,'Guasto',45,'Crotone','KR'),
          base(38.701,16.091,'Guasto',210,'Catanzaro','CZ'),
          base(38.678,16.100,'Lavoro Programmato',15,'Lamezia Terme','CZ'),
          base(38.521,16.210,'Guasto',75,'Vibo Valentia','VV')
        ];
      }
      function jsonp(url, timeout=7000){
        return new Promise((resolve,reject)=>{
          const cb = '__pg_jsonp_'+Math.random().toString(36).slice(2);
          const s = document.createElement('script');
          const sep = url.includes('?') ? '&' : '?';
          s.src = url + sep + 'callback=' + cb;
          let done=false;
          const timer = setTimeout(()=>{cleanup();reject(new Error('JSONP timeout'));}, timeout);
          function cleanup(){ if(done) return; done=true; clearTimeout(timer); if(window[cb]) delete window[cb]; if(s.parentNode) s.parentNode.removeChild(s); }
          window[cb] = (data)=>{ cleanup(); resolve(data); };
          s.onerror = ()=>{ cleanup(); reject(new Error('JSONP load error')); };
          document.head.appendChild(s);
        });
      }

      // ========= MAPPA =========
      const map = L.map('map', { zoomControl: true, attributionControl: false });
      window.map = map; // Esponi map globalmente per il refresh post-splash
      const baseOSM = baseLayers.osm.addTo(map); // default OSM
      const CALABRIA_BOUNDS = L.latLngBounds([[37.9, 15.5],[39.8, 17.4]]);
      
      // Apri inizialmente sull'Italia intera
      map.setView([42.5, 12.5], 6); // Vista Italia
      const markers = L.layerGroup().addTo(map);

      // ========= FETCH ROBUSTO =========
      async function fetchOutages({ cause = 'all', bbox = map.getBounds() } = {}){
        const geom = { xmin: bbox.getWest(), ymin: bbox.getSouth(), xmax: bbox.getEast(), ymax: bbox.getNorth(), spatialReference: { wkid: 4326 } };
        const where = (cause !== 'all') ? `causa_disalimentazione='${cause.replace(/'/g,"''")}'` : '1=1';
        const params = new URLSearchParams({ f: 'json', where, outFields: '*', returnGeometry: 'true', outSR: '4326', geometry: JSON.stringify(geom), geometryType: 'esriGeometryEnvelope', inSR: '4326', spatialRel: 'esriSpatialRelIntersects', resultRecordCount: '2000' });
        const url = `${FEATURE_SERVER}?${params.toString()}`;

        try{
          const res = await fetch(url, { mode: 'cors' });
          if(!res.ok) throw new Error('HTTP '+res.status);
          const data = await res.json();
          if(data.error) throw new Error(data.error.message || 'ArcGIS error');
          addTest('ArcGIS (fetch)', true);
          return (data.features||[]);
        }catch(e){ addTest('ArcGIS (fetch)', false, e.message||String(e)); }

        try{
          const data = await jsonp(url);
          if(data && !data.error){ addTest('ArcGIS (JSONP)', true); return (data.features||[]); }
          throw new Error(data && data.error ? data.error.message : 'Nessun dato JSONP');
        }catch(e){ addTest('ArcGIS (JSONP)', false, e.message||String(e)); }

        // DEMO
        addTest('Fallback DEMO', true, 'HTTP 403 o CORS');
        return demoFeatures();
      }

      function colorByCause(cause){ if(/guasto/i.test(cause)) return getComputedStyle(document.documentElement).getPropertyValue('--err') || '#ff6b6b'; if(/lavoro/i.test(cause)) return getComputedStyle(document.documentElement).getPropertyValue('--warn') || '#ff9f1c'; return getComputedStyle(document.documentElement).getPropertyValue('--accent-2') || '#4aa3ff'; }
      function formatDate(val){
        if(!val) return '—';
        const n = Number(val);
        let d;

        // Prova timestamp in millisecondi
        if (isFinite(n) && n > 1000000000) {
          d = new Date(n);
        }
        // Prova timestamp in secondi (convertilo in millisecondi)
        else if (isFinite(n) && n > 1000000) {
          d = new Date(n * 1000);
        }
        // Prova come stringa data
        else {
          d = new Date(val);
        }

        if(isNaN(d)) return String(val);

        return d.toLocaleString('it-IT', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      function featureToMarker(f){
        const g = f.geometry; if(!g || !g.x || !g.y) return null; const attrs = f.attributes || {};
        const cause = (pickAttr(attrs, ['causa_disalimentazione','causa']) || 'n/d');
        const color = colorByCause(cause);
        const m = L.circleMarker([g.y, g.x], { radius: 8, weight: 2, color: '#fff', fillColor: color, fillOpacity: .9 });
        const comune = pickAttr(attrs, ['comune','municipio']) || 'N/D'; // Cambiato in N/D per coerenza
        const provincia = pickAttr(attrs, ['provincia','prov']) || 'N/D';
        const title = [comune, provincia].filter(Boolean).join(' · ');
        const ncliRaw = pickAttr(attrs, ['num_cli_disalim','clienti','numero_clienti']); const ncli = ncliRaw != null ? Number(ncliRaw) : null;
        const dataInizio = pickAttr(attrs, ['data_interruzione','data_inizio','inizio','start','start_time','outage_start']); // Corretto per data_interruzione
        const dataPrev = pickAttr(attrs, ['data_prev_ripristino','data_fine_prevista','fine_prevista','eta','estimated_end','planned_end','ripristino_previsto']); // Corretto per data_prev_ripristino
        const dataFine = pickAttr(attrs, ['data_fine_effettiva','fine_effettiva','end']); // Aggiunto data_fine_effettiva

        // Evento click diretto sul marker per aprire dettagli - senza popup intermedio
        m.on('click', () => {
          openEventDetails(f);
        });

        return m;
      }

      let currentCause = 'all'; let currentRegion = 'Tutta Italia';

      async function loadAndRender(){
        try{
          // Se currentRegion è "Tutta Italia", usa bbox Italia completa
          let bbox;
          if (currentRegion === 'Tutta Italia') {
            bbox = L.latLngBounds([[35.3, 6.6], [47.2, 18.8]]); // Bbox Italia completa
          } else if (REGION_BBOX[currentRegion]) {
            bbox = L.latLngBounds(REGION_BBOX[currentRegion]);
          } else {
            bbox = map.getBounds();
          }
          
          const feats = await fetchOutages({ cause: currentCause, bbox });
          markers.clearLayers();
          feats.forEach(f=>{ const m = featureToMarker(f); if(m) markers.addLayer(m); });
          window.lastFeatures = feats;
        }catch(err){
          console.error(err);
          const box = document.getElementById('errorOverlay');
          if(box){ box.style.display='block'; box.innerHTML = `<b>Caricamento fallito:</b> ${err.message||err}`; }
        }
      }

      async function loadAndRenderWithFilters(){
        try{
          let bbox;

          // Determina il bbox in base alla regione selezionata
          if (activeFilters.region === 'all') {
            // Per tutte le regioni, usa un bbox che copre tutta l'Italia
            bbox = L.latLngBounds([[35.3, 6.6], [47.2, 18.8]]);
            currentRegion = 'Tutta Italia';
          } else if (REGION_BBOX[activeFilters.region]) {
            bbox = L.latLngBounds(REGION_BBOX[activeFilters.region]);
            currentRegion = activeFilters.region;
          } else {
            // Fallback alla vista corrente della mappa
            bbox = map.getBounds();
          }

          const feats = await fetchOutages({ cause: currentCause, bbox });
          markers.clearLayers();

          // Applica filtri aggiuntivi sui risultati
          let filteredFeats = feats;

          // Filtro per numero utenti
          if (activeFilters.users > 0) {
            filteredFeats = filteredFeats.filter(f => {
              const users = Number(pickAttr(f.attributes, ['num_cli_disalim', 'clienti']) || 0);
              return users >= activeFilters.users;
            });
          }

          // Filtro per durata
          if (activeFilters.duration !== 'any') {
            filteredFeats = filteredFeats.filter(f => {
              const attrs = f.attributes || {};
              const start = Number(pickAttr(attrs, ['data_interruzione', 'data_inizio', 'inizio']) || 0);
              const end = Number(pickAttr(attrs, ['data_prev_ripristino', 'data_fine_prevista', 'fine_prevista']) || 0);

              if (!start || !end) return true;

              const durationHours = (end - start) / (1000 * 60 * 60);

              switch (activeFilters.duration) {
                case 'lt1': return durationHours < 1;
                case '1to4': return durationHours >= 1 && durationHours <= 4;
                case 'gt4': return durationHours > 4;
                default: return true;
              }
            });
          }

          // Aggiungi i marker filtrati alla mappa
          filteredFeats.forEach(f => {
            const m = featureToMarker(f);
            if (m) markers.addLayer(m);
          });

          window.lastFeatures = filteredFeats;

          // Centra la mappa sulla regione se necessario
          if (activeFilters.region === 'all') {
            map.setView([42.5, 12.5], 6); // Vista Italia
          } else if (REGION_BBOX[activeFilters.region]) {
            map.fitBounds(bbox.pad(0.08));
          }

        } catch(err) {
          console.error(err);
          const box = document.getElementById('errorOverlay');
          if(box){
            box.style.display='block';
            box.innerHTML = `<b>Caricamento filtrato fallito:</b> ${err.message||err}`;
          }
        }
      }

      // Filtri rapidi
      document.getElementById('causeChips').addEventListener('click', (e)=>{
        const chip = e.target.closest('.chip'); if(!chip) return;
        [...document.querySelectorAll('#causeChips .chip')].forEach(c=>c.dataset.active='false');
        chip.dataset.active='true';
        currentCause = chip.dataset.value;
        loadAndRender();
      });

      // ======= GESTIONE MODALE SELEZIONE MAPPE =======
      const layersModal = document.getElementById('layersModal');
      const layersBtn = document.getElementById('fabLayers');
      const layersClose = document.getElementById('layersClose');
      const layersClose2 = document.getElementById('layersClose2');
      const layersBackdrop = document.getElementById('layersBackdrop');

      // Funzione globale per gestire z-index header
      function setHeaderBelowModals(isModalOpen) {
        const header = document.querySelector('header');
        if (header) {
          if (isModalOpen) {
            header.classList.add('modal-open');
          } else {
            header.classList.remove('modal-open');
          }
        }
      }

      function openLayersModal() {
        // Evidenzia il layer attualmente attivo
        document.querySelectorAll('.layer-item').forEach(item => {
          item.removeAttribute('data-active');
        });

        // Trova il layer attivo e marcalo
        Object.entries(baseLayers).forEach(([key, layer]) => {
          if (map.hasLayer(layer)) {
            const activeItem = document.querySelector(`[data-layer="${key}"]`);
            if (activeItem) {
              activeItem.setAttribute('data-active', 'true');
            }
          }
        });

        layersModal.setAttribute('data-open', 'true');
        layersModal.setAttribute('aria-hidden', 'false');
        setHeaderBelowModals(true);
      }

      function closeLayersModal() {
        layersModal.setAttribute('data-open', 'false');
        layersModal.setAttribute('aria-hidden', 'true');
        setHeaderBelowModals(false);
      }

      function selectLayer(layerKey) {
        try {
          // Rimuovi tutti i layer attuali
          Object.values(baseLayers).forEach(layer => {
            if (map.hasLayer(layer)) {
              map.removeLayer(layer);
            }
          });

          // Aggiungi il nuovo layer
          if (baseLayers[layerKey]) {
            baseLayers[layerKey].addTo(map);

            // Trova il nome del layer per la notifica
            const layerNames = {
              positron: 'Stradale Chiara',
              osm: 'OpenStreetMap',
              dark: 'Stradale Scura',
              sat: 'Satellite',
              hybrid: 'Ibrida',
              terrain: 'Terreno',
              watercolor: 'Watercolor'
            };

            notifications.add('success', `Mappa cambiata: ${layerNames[layerKey] || layerKey}`);
            closeLayersModal();
          } else {
            notifications.add('error', 'Layer non disponibile');
          }
        } catch (error) {
          console.error('Errore cambio layer:', error);
          notifications.add('error', 'Errore nel cambio mappa');
        }
      }

      // Event listeners per la modale layer
      layersBtn?.addEventListener('click', openLayersModal);
      layersClose?.addEventListener('click', closeLayersModal);
      layersClose2?.addEventListener('click', closeLayersModal);
      layersBackdrop?.addEventListener('click', closeLayersModal);

      // Event listener per selezione layer
      layersModal?.addEventListener('click', (e) => {
        const item = e.target.closest('.layer-item');
        if (item) {
          const layerKey = item.getAttribute('data-layer');
          if (layerKey) {
            selectLayer(layerKey);
          }
        }
      });



      // Fit helpers
      document.getElementById('fitCalabria').addEventListener('click', ()=> map.fitBounds(L.latLngBounds(REGION_BBOX['Calabria']).pad(0.08)));
      document.getElementById('fitItaly').addEventListener('click', ()=> map.setView([42.5,12.5], 6));

      // Refresh
      document.getElementById('fabRefresh').addEventListener('click', loadAndRender);

      // Settings
      document.getElementById('fabSettings').addEventListener('click', openSettingsModal);

      // Auto reload on move (debounce)
      let t; map.on('moveend', ()=>{ clearTimeout(t); t=setTimeout(()=>loadAndRender(), 220); });

      // Gestione FAB per mobile
      function updateMobileFunctionality() {
        // Test tutti i pulsanti FAB per mobile
        const fabButtons = document.querySelectorAll('.fab button');
        fabButtons.forEach(btn => {
          btn.style.touchAction = 'manipulation';
          // Assicura che i click funzionino su mobile
          if (!btn.hasAttribute('data-mobile-ready')) {
            btn.addEventListener('touchstart', function(e) {
              e.preventDefault();
              this.click();
            }, { passive: false });
            btn.setAttribute('data-mobile-ready', 'true');
          }
        });
      }

      // Gestione resize window
      window.addEventListener('resize', updateMobileFunctionality);
      updateMobileFunctionality();

      // Sistema notifiche
      const notifications = {
        container: document.getElementById('notifications'),
        add(type, message, autoRemove = true) {
          const item = document.createElement('div');
          item.className = 'notification-item animate-fade';
          item.setAttribute('data-type', type);

          const icons = { info: 'ℹ️', warning: '⚠️', error: '❌', success: '✅' };
          const time = new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });

          item.innerHTML = `
            <span class="notification-icon">${icons[type] || 'ℹ️'}</span>
            <span class="notification-text">${message}</span>
            <span class="notification-time">${time}</span>
          `;

          this.container.appendChild(item);

          if (autoRemove) {
            setTimeout(() => {
              if (item.parentNode) {
                item.style.opacity = '0';
                item.style.transform = 'translateX(-100%)';
                setTimeout(() => item.remove(), 300);
              }
            }, 5000);
          }

          // Mantieni solo le ultime 5 notifiche
          while (this.container.children.length > 5) {
            this.container.removeChild(this.container.firstChild);
          }
        }
      };

      // Aggiornamento tempo reale
      function updateConnectionStatus() {
        const statusEl = document.getElementById('connectionStatus');
        const textEl = document.getElementById('connectionText');
        const updateEl = document.getElementById('lastUpdate');
        const timeEl = document.getElementById('currentTime');

        const now = new Date();
        if (timeEl) timeEl.textContent = now.toLocaleTimeString('it-IT');
        if (updateEl) updateEl.textContent = `Aggiornato ${now.toLocaleTimeString('it-IT')}`;

        // Simula controllo connessione
        const isOnline = navigator.onLine;
        if (statusEl && textEl) {
          statusEl.className = `status-indicator ${isOnline ? 'status-online' : 'status-offline'}`;
          textEl.textContent = isOnline ? 'Online' : 'Offline';
        }
      }

      // Funzioni di supporto
      function showDesktopNotification(title, body, icon) {
        if ('Notification' in window && Notification.permission === 'granted') {
          try {
            const notification = new Notification(title, {
              body: body,
              icon: icon,
              badge: icon,
              tag: 'poweringuasti-alert',
              renotify: true,
              vibrate: [200, 100, 200],
              requireInteraction: false
            });

            notification.onclick = function() {
              window.focus();
              notification.close();
            };

            setTimeout(() => {
              notification.close();
            }, 10000);

          } catch (error) {
            console.warn('Errore notifica desktop:', error);
          }
        }
      }

      function requestNotificationPermission() {
        if (!('Notification' in window)) {
          notifications.add('error', 'Notifiche desktop non supportate dal browser');
          updateNotificationStatus();
          return;
        }

        Notification.requestPermission().then(permission => {
          updateNotificationStatus();

          if (permission === 'granted') {
            notifications.add('success', 'Notifiche desktop attivate con successo!');
            showDesktopNotification(
              '🔔 POWERINGUASTI',
              'Notifiche desktop ora attive! Riceverai avvisi per i nuovi guasti in Calabria.',
              'attached_assets/logo3d-1024x1024_1754913410278.png'
            );
          } else if (permission === 'denied') {
            notifications.add('error', 'Notifiche desktop negate. Puoi riattivarle dalle impostazioni del browser.');
          } else {
            notifications.add('warning', 'Permesso notifiche in sospeso');
          }
        }).catch(error => {
          console.error('Errore richiesta notifiche:', error);
          notifications.add('error', 'Errore nell\'attivazione delle notifiche');
        });
      }

      function testNotificationSound() {
        playNotificationSound();
        notifications.add('info', 'Riproduzione suono di test');
      }

      function playNotificationSound() {
        if (!currentSettings.sounds) return;

        const soundType = currentSettings.soundType;
        const volume = currentSettings.volume / 100;

        if ('vibrate' in navigator) {
          if (soundType === 'siren') {
            navigator.vibrate([300, 100, 300, 100, 300, 100, 300]);
          } else {
            navigator.vibrate([200, 100, 200]);
          }
        }

        if (!('AudioContext' in window || 'webkitAudioContext' in window)) {
          console.warn('AudioContext non supportato');
          return;
        }

        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();

          if (soundType === 'system') {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();

            osc.connect(gain);
            gain.connect(ctx.destination);

            osc.type = 'sine';
            osc.frequency.value = 800;
            gain.gain.setValueAtTime(volume * 0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);

            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + 0.3);

          } else if (soundType === 'siren') {
            const duration = 2.5;
            const segments = 8;
            const segmentDuration = duration / segments;

            for (let i = 0; i < segments; i++) {
              setTimeout(() => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();

                osc.connect(gain);
                gain.connect(ctx.destination);

                osc.type = 'sawtooth';

                const isEven = i % 2 === 0;
                const startFreq = isEven ? 600 : 900;
                const endFreq = isEven ? 900 : 600;

                osc.frequency.setValueAtTime(startFreq, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(endFreq, ctx.currentTime + segmentDuration);

                const maxVolume = volume * 0.4;
                gain.gain.setValueAtTime(0, ctx.currentTime);
                gain.gain.linearRampToValueAtTime(maxVolume, ctx.currentTime + 0.05);
                gain.gain.linearRampToValueAtTime(maxVolume, ctx.currentTime + segmentDuration - 0.05);
                gain.gain.linearRampToValueAtTime(0, ctx.currentTime + segmentDuration);

                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + segmentDuration);

              }, i * segmentDuration * 1000);
            }

            setTimeout(() => {
              const finalOsc = ctx.createOscillator();
              const finalGain = ctx.createGain();

              finalOsc.connect(finalGain);
              finalGain.connect(ctx.destination);

              finalOsc.type = 'sine';
              finalOsc.frequency.value = 750;

              finalGain.gain.setValueAtTime(volume * 0.3, ctx.currentTime);
              finalGain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.8);

              finalOsc.start(ctx.currentTime);
              finalOsc.stop(ctx.currentTime + 0.8);

            }, duration * 1000);
          }

        } catch (e) {
          console.error('Errore riproduzione suono:', e);
          notifications.add('warning', 'Impossibile riprodurre suono di notifica');
        }
      }

      // Sistema di rilevamento nuovi guasti
      let lastKnownOutages = new Set();
      let isFirstLoad = true;

      function checkForNewOutages(currentFeatures) {
        if (!currentSettings.notifications) return;

        const currentOutages = new Set();
        const calabriaProvinces = ['CS', 'RC', 'CZ', 'VV', 'KR', 'Cosenza', 'Reggio Calabria', 'Catanzaro', 'Vibo Valentia', 'Crotone'];

        currentFeatures.forEach(feature => {
          const attrs = feature.attributes || {};
          const provincia = pickAttr(attrs, ['provincia', 'prov']) || '';
          const comune = pickAttr(attrs, ['comune', 'municipio']) || '';
          const cause = pickAttr(attrs, ['causa_disalimentazione', 'causa']) || '';
          const id = attrs.id_interruzione || attrs.objectid || attrs.objectid1 || Math.random();

          const isCalabria = calabriaProvinces.some(prov => {
            const provStr = String(provincia || '').toLowerCase();
            const comuneStr = String(comune || '').toLowerCase();
            const provLower = String(prov || '').toLowerCase();

            return provStr.includes(provLower) || comuneStr.includes('calabria');
          });

          // Mostra notifiche in base alla regione correntemente selezionata e alle impostazioni
          const shouldNotify = currentRegion === 'Tutta Italia' ? 
            (currentSettings.onlyCalabria ? isCalabria : true) : 
            (currentSettings.onlyCalabria ? isCalabria : true);

          if (shouldNotify) {
            currentOutages.add(id);

            if (!isFirstLoad && !lastKnownOutages.has(id)) {
              const ncli = Number(pickAttr(attrs, ['num_cli_disalim', 'clienti']) || 0);
              const location = [comune, provincia].filter(Boolean).join(' · ') || 'Località sconosciuta';

              notifications.add('warning', `🚨 NUOVO GUASTO: ${location} - ${ncli} utenti coinvolti`);

              if (currentSettings.sounds) {
                playNotificationSound();
              }

              if (currentSettings.desktopNotifications && Notification.permission === 'granted') {
                showDesktopNotification(
                  '🚨 POWERINGUASTI - Nuovo Guasto',
                  `${location}\n${cause} - ${ncli} utenti coinvolti`,
                  'attached_assets/logo3d-1024x1024_1754913410278.png'
                );
              }

              console.log(`NUOVO GUASTO RILEVATO: ${location} - ID: ${id}`);
            }
          }
        });

        lastKnownOutages = currentOutages;
        isFirstLoad = false;
      }

      // ======= GESTIONE MODALE DETTAGLI EVENTO =======
      const eventModal = document.getElementById('eventModal');
      const eventClose = document.getElementById('eventClose');
      const eventClose2 = document.getElementById('eventClose2');
      const eventBackdrop = document.getElementById('eventBackdrop');
      let currentEventFeature = null;

      async function reverseGeocode(lat, lon) {
        try {
          const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1`, {
            headers: { 'User-Agent': 'PowerInGuasti/1.0' }
          });
          const data = await response.json();
          if (data && data.address) {
            const comune = data.address.city || data.address.town || data.address.village || data.address.municipality || 'Sconosciuto';
            const provincia = data.address.state || data.address.province || 'N/D';
            return { comune, provincia };
          }
        } catch (e) {
          console.warn('Reverse geocoding fallito:', e);
        }
        return { comune: 'Sconosciuto', provincia: 'N/D' };
      }

      function formatApiDate(value) {
        if (!value || value === null || value === undefined) return '—';

        try {
          const numValue = Number(value);
          if (isFinite(numValue) && numValue > 1000000000) {
            const date = new Date(numValue);
            if (!isNaN(date.getTime())) {
              return date.toLocaleString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              });
            }
          }

          if (typeof value === 'string' && value.includes('/')) {
            const parts = value.trim().split(' ');
            const datePart = parts[0];
            const timePart = parts[1] || '00:00';

            const [day, month, year] = datePart.split('/');
            if (day && month && year) {
              const isoDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${timePart}:00`;
              const date = new Date(isoDate);

              if (!isNaN(date.getTime())) {
                return date.toLocaleString('it-IT', {
                  day: '2-digit',
                  month: '2-digit',
                  year: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                });
              }
            }
          }

          const dateFromString = new Date(value);
          if (!isNaN(dateFromString.getTime())) {
            return dateFromString.toLocaleString('it-IT', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          }

          return String(value);
        } catch (e) {
          console.warn('Errore formattazione data:', value, e);
          return String(value);
        }
      }

      function safeSetText(elementId, text) {
        try {
          const element = document.getElementById(elementId);
          if (element) {
            element.textContent = text || '—';
            return true;
          } else {
            console.warn(`Elemento non trovato: ${elementId}`);
            return false;
          }
        } catch (e) {
          console.error(`Errore impostando testo per ${elementId}:`, e);
          return false;
        }
      }

      function safeSetStyle(elementId, property, value) {
        try {
          const element = document.getElementById(elementId);
          if (element) {
            element.style[property] = value;
            return true;
          } else {
            console.warn(`Elemento non trovato per stile: ${elementId}`);
            return false;
          }
        } catch (e) {
          console.error(`Errore impostando stile per ${elementId}:`, e);
          return false;
        }
      }

      async function openEventDetails(feature) {
        try {
          console.log('Apertura dettagli evento:', feature);
          currentEventFeature = feature;
          const attrs = feature.attributes || {};
          const g = feature.geometry || {};

          // Verifica che la modale esista
          if (!eventModal) {
            console.error('Modale evento non trovata nel DOM');
            return;
          }

          // Informazioni base
          const cause = pickAttr(attrs, ['causa_disalimentazione','causa']) || 'Non specificato';

          // Ottieni comune e provincia dalle coordinate se lat/lon sono disponibili
          let comune = 'Identificazione...';
          let provincia = 'N/D';

          // Fallback ai dati API se disponibili
          const apiComune = pickAttr(attrs, ['comune','municipio','city','town']);
          const apiProvincia = pickAttr(attrs, ['provincia','prov','province','state']);

          if (apiComune && apiComune !== '' && typeof apiComune === 'string' && !apiComune.match(/^\d+$/)) {
            comune = apiComune;
          }
          if (apiProvincia && apiProvincia !== '' && typeof apiProvincia === 'string' && !apiProvincia.match(/^\d+$/)) {
            provincia = apiProvincia;
          }

          // Se non abbiamo i dati API, prova reverse geocoding
          if ((comune === 'Identificazione...' || !apiComune) && g.x && g.y) {
            try {
              const geoData = await reverseGeocode(g.y, g.x);
              comune = geoData.comune;
              provincia = geoData.provincia;
            } catch (e) {
              console.warn('Reverse geocoding fallito:', e);
              comune = 'Coordinate: ' + (g.x && g.y ? `${Number(g.y).toFixed(2)}, ${Number(g.x).toFixed(2)}` : 'N/D');
            }
          }

          // Dati numerici
          const ncliRaw = pickAttr(attrs, ['num_cli_disalim','clienti','numero_clienti','affected_customers']);
          const ncli = ncliRaw != null ? Number(ncliRaw) : 0;

          // Date e tempi dall'API
          const dataInizio = pickAttr(attrs, ['data_interruzione','data_inizio','inizio','start','start_time','outage_start']); // Mappato correttamente
          const dataUltimoAgg = pickAttr(attrs, ['dataultimoaggiornamento','ultimo_aggiornamento','last_update','updated','modified']) || dataInizio; // Mappato correttamente
          const dataRipristino = pickAttr(attrs, ['data_prev_ripristino','data_fine_prevista','fine_prevista','eta','estimated_end','planned_end','ripristino_previsto']); // Mappato correttamente

          // Calcola durata stimata per il pannello impatto
          let durataPrevista = '—';
          if (dataInizio && dataRipristino) {
            try {
              let startMs, endMs;

              // Funzione helper per convertire data stringa in timestamp
              function parseApiDate(dateStr) {
                if (typeof dateStr === 'string' && dateStr.includes('/')) {
                  const parts = dateStr.trim().split(' ');
                  const datePart = parts[0];
                  const timePart = parts[1] || '00:00';

                  const [day, month, year] = datePart.split('/');
                  if (day && month && year) {
                    const isoDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${timePart}:00`;
                    return new Date(isoDate).getTime();
                  }
                }
                return Number(dateStr);
              }

              startMs = parseApiDate(dataInizio);
              endMs = parseApiDate(dataRipristino);

              if (isFinite(startMs) && isFinite(endMs) && endMs > startMs) {
                const diffHours = (endMs - startMs) / (1000 * 60 * 60);
                durataPrevista = diffHours > 0 ? Math.round(diffHours * 10) / 10 + 'h' : '—';
              }
            } catch (e) {
              console.warn('Errore calcolo durata:', e);
              durataPrevista = '—';
            }
          }

          // Determina stato
          let stato = 'Attivo';
          let statusColor = '#e53935';

          // Controlla se c'è un campo che indica risoluzione
          const dataRisoluzione = pickAttr(attrs, ['data_fine_effettiva','fine_effettiva','end','actual_end','risolto','resolved']);
          const now = Date.now();

          try {
            // Funzione helper per convertire data API in timestamp
            function parseApiDateToMs(dateStr) {
              if (!dateStr) return null;

              if (typeof dateStr === 'string' && dateStr.includes('/')) {
                const parts = dateStr.trim().split(' ');
                const datePart = parts[0];
                const timePart = parts[1] || '00:00';

                const [day, month, year] = datePart.split('/');
                if (day && month && year) {
                  const isoDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${timePart}:00`;
                  const ms = new Date(isoDate).getTime();
                  return isFinite(ms) ? ms : null;
                }
              }

              const numMs = Number(dateStr);
              return isFinite(numMs) ? numMs : null;
            }

            if (dataRisoluzione) {
              const resolvedMs = parseApiDateToMs(dataRisoluzione);
              if (resolvedMs && resolvedMs < now) {
                stato = 'Risolto';
                statusColor = '#10b981';
              }
            } else if (dataRipristino) {
              const endMs = parseApiDateToMs(dataRipristino);
              if (endMs && endMs < now) {
                stato = 'In Ritardo';
                statusColor = '#ff9f1c';
              }
            }
          } catch (e) {
            console.warn('Errore determinazione stato:', e);
            // Mantieni i valori di default
          }

          // Debug: controlla se tutti gli elementi esistono
          const requiredElements = [
            'eventIcon', 'eventLocation', 'eventType', 'eventStatus',
            'eventComune', 'eventProvincia', 'eventCoordinate',
            'eventClienti', 'eventDurata',
            'eventInizio', 'eventUltimoAggiornamento', 'eventRipristinoPrevisto'
          ];

          const missingElements = requiredElements.filter(id => !document.getElementById(id));
          if (missingElements.length > 0) {
            console.warn('Elementi mancanti nella modale:', missingElements);
            // Se mancano elementi critici, non aprire la modale
            notifications.add('error', 'Errore nell\'interfaccia dei dettagli evento');
            return;
          }

          // Popola la modale con controlli di sicurezza
          safeSetText('eventIcon', /guasto/i.test(cause) ? '⚡' : '🔧');
          safeSetText('eventLocation', [comune, provincia].filter(Boolean).join(' · ') || 'Evento Elettrico');
          safeSetText('eventType', cause);
          safeSetStyle('eventType', 'color', /guasto/i.test(cause) ? '#e53935' : '#ff9f1c');
          safeSetText('eventStatus', stato);
          safeSetStyle('eventStatus', 'color', statusColor);

          // Localizzazione
          safeSetText('eventComune', comune);
          safeSetText('eventProvincia', provincia);
          safeSetText('eventCoordinate', g.x && g.y ?
            `${Number(g.y).toFixed(4)}, ${Number(g.x).toFixed(4)}` : 'Non disponibili');

          // Impatto
          safeSetText('eventClienti', ncli > 0 ? ncli.toLocaleString('it-IT') : '0');
          safeSetText('eventDurata', durataPrevista);

          // Tempi con formattazione migliorata
          safeSetText('eventInizio', formatApiDate(dataInizio));
          safeSetText('eventUltimoAggiornamento', formatApiDate(dataUltimoAgg));
          safeSetText('eventRipristinoPrevisto', formatApiDate(dataRipristino));

          // Note (se disponibili)
          const note = pickAttr(attrs, ['note','description','commento','notes']);
          const notePanel = document.getElementById('eventNote');
          if (notePanel) {
            if (note && note.trim()) {
              safeSetText('eventNoteText', note);
              notePanel.style.display = 'block';
            } else {
              notePanel.style.display = 'none';
            }
          }

          // Debug dati popolati
          console.log('Dati popolati:',{
            cause, comune, provincia, ncli,
            dataInizio: formatApiDate(dataInizio),
            dataRipristino: formatApiDate(dataRipristino),
            stato, durataPrevista
          });

          // Apri modale
          eventModal.setAttribute('data-open', 'true');
          eventModal.setAttribute('aria-hidden', 'false');
          setHeaderBelowModals(true);

          notifications.add('info', `Aperti dettagli: ${[comune, provincia].filter(Boolean).join(' · ')}`);

        } catch (error) {
          console.error('Errore nell\'apertura dei dettagli evento:', error);
          notifications.add('error', 'Errore nell\'apertura dei dettagli');
        }
      }

      function closeEventDetails() {
        eventModal.setAttribute('data-open', 'false');
        eventModal.setAttribute('aria-hidden', 'true');
        currentEventFeature = null;
        setHeaderBelowModals(false);
      }

      function zoomToEvent() {
        if (currentEventFeature && currentEventFeature.geometry) {
          const g = currentEventFeature.geometry;
          map.setView([g.y, g.x], 15);
          closeEventDetails();
          notifications.add('info', 'Mappa centrata sull\'evento');
        }
      }

      function getDirectionsToEvent() {
        if (!currentEventFeature || !currentEventFeature.geometry) {
          notifications.add('error', 'Nessun evento selezionato');
          return;
        }

        const { geometry } = currentEventFeature;
        const { x: eventLon, y: eventLat } = geometry;

        if (!eventLat || !eventLon || isNaN(eventLat) || isNaN(eventLon)) {
          notifications.add('error', 'Coordinate evento non valide');
          return;
        }

        // Controlla se le librerie sono caricate
        if (typeof L === 'undefined') {
          notifications.add('error', 'Leaflet non caricato');
          return;
        }

        if (typeof L.Routing === 'undefined' || !L.Routing.control) {
          // Fallback: apri Google Maps in una nuova scheda
          const googleMapsUrl = `https://www.google.com/maps/dir///${eventLat},${eventLon}/@${eventLat},${eventLon},15z`;
          window.open(googleMapsUrl, '_blank');
          notifications.add('success', 'Indicazioni aperte in Google Maps');
          closeEventDetails();
          return;
        }

        // Ottieni la posizione corrente dell'utente
        if (!navigator.geolocation) {
          notifications.add('warning', 'Geolocalizzazione non supportata. Apertura Google Maps...');
          const googleMapsUrl = `https://www.google.com/maps/dir///${eventLat},${eventLon}/@${eventLat},${eventLon},15z`;
          window.open(googleMapsUrl, '_blank');
          closeEventDetails();
          return;
        }

        notifications.add('info', 'Richiesta posizione in corso...');

        navigator.geolocation.getCurrentPosition((position) => {
          const userLat = position.coords.latitude;
          const userLon = position.coords.longitude;

          try {
            // Inizializza il routing machine con controlli di sicurezza
            const control = L.Routing.control({
              waypoints: [
                L.latLng(userLat, userLon),
                L.latLng(eventLat, eventLon)
              ],
              routeWhileDragging: false,
              addWaypoints: false,
              createMarker: function() { return null; }, // Non creare marker automatici
              lineOptions: {
                styles: [{ color: '#007bff', weight: 5, opacity: 0.7 }]
              },
              router: L.Routing.osrmv1({
                serviceUrl: 'https://router.project-osrm.org/route/v1/driving',
                profile: 'driving',
                language: 'it'
              }),
              formatter: new L.Routing.Formatter({ language: 'it' }),
              show: false
            });

            let routeFound = false;

            // Timeout di sicurezza
            const timeoutId = setTimeout(() => {
              if (!routeFound) {
                try {
                  map.removeControl(control);
                } catch (e) {}
                const googleMapsUrl = `https://www.google.com/maps/dir/${userLat},${userLon}/${eventLat},${eventLon}`;
                window.open(googleMapsUrl, '_blank');
                notifications.add('warning', 'Timeout routing - apertura Google Maps');
                closeEventDetails();
              }
            }, 10000);

            control.on('routesfound', function(e) {
              routeFound = true;
              clearTimeout(timeoutId);

              try {
                const routes = e.routes;
                if (routes && routes.length > 0) {
                  const route = routes[0];

                  if (route.coordinates && route.coordinates.length > 0) {
                    // Adatta la mappa alla rotta
                    const bounds = L.latLngBounds(route.coordinates);
                    map.fitBounds(bounds.pad(0.1));

                    notifications.add('success', 'Indicazioni generate! Percorso visualizzato sulla mappa');
                    closeEventDetails();
                  } else {
                    throw new Error('Coordinate rotta non valide');
                  }
                } else {
                  throw new Error('Nessuna rotta trovata');
                }
              } catch (err) {
                console.error('Errore elaborazione rotta:', err);
                const googleMapsUrl = `https://www.google.com/maps/dir/${userLat},${userLon}/${eventLat},${eventLon}`;
                window.open(googleMapsUrl, '_blank');
                notifications.add('warning', 'Errore routing - apertura Google Maps');
                closeEventDetails();
              }
            });

            control.on('routingerror', function(e) {
              routeFound = true;
              clearTimeout(timeoutId);
              console.error('Errore routing:', e);

              try {
                map.removeControl(control);
              } catch (err) {}

              const googleMapsUrl = `https://www.google.com/maps/dir/${userLat},${userLon}/${eventLat},${eventLon}`;
              window.open(googleMapsUrl, '_blank');
              notifications.add('warning', 'Servizio routing non disponibile - apertura Google Maps');
              closeEventDetails();
            });

            // Aggiungi il controllo alla mappa
            control.addTo(map);

          } catch (err) {
            console.error('Errore inizializzazione routing:', err);
            const googleMapsUrl = `https://www.google.com/maps/dir/${userLat},${userLon}/${eventLat},${eventLon}`;
            window.open(googleMapsUrl, '_blank');
            notifications.add('warning', 'Errore sistema routing - apertura Google Maps');
            closeEventDetails();
          }
        }, (error) => {
          let errorMessage = 'Geolocalizzazione: ';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMessage += 'Permesso negato';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage += 'Posizione non disponibile';
              break;
            case error.TIMEOUT:
              errorMessage += 'Timeout richiesta';
              break;
            default:
              errorMessage += 'Errore sconosciuto';
          }

          // Fallback: apri Google Maps senza posizione utente
          const googleMapsUrl = `https://www.google.com/maps/dir///${eventLat},${eventLon}/@${eventLat},${eventLon},15z`;
          window.open(googleMapsUrl, '_blank');
          notifications.add('warning', errorMessage + ' - Apertura Google Maps');
          closeEventDetails();
        }, {
          enableHighAccuracy: false,
          timeout: 10000,
          maximumAge: 300000
        });
      }


      

      // Rendi la funzione globale per essere chiamata dai popup
      window.openEventDetails = openEventDetails;



      // ======= ELEMENTI DOM IMPOSTAZIONI =======
      const settingsModal = document.getElementById('settingsModal');
      const settingsClose = document.getElementById('settingsClose');
      const settingsClose2 = document.getElementById('settingsClose2');
      const settingsBackdrop = document.getElementById('settingsBackdrop');

      function openSettingsModal() {
        loadSettings();
        if (settingsModal) {
          settingsModal.setAttribute('data-open', 'true');
          settingsModal.setAttribute('aria-hidden', 'false');
          setHeaderBelowModals(true);
        }
      }

      function closeSettingsModal() {
        if (settingsModal) {
          settingsModal.setAttribute('data-open', 'false');
          settingsModal.setAttribute('aria-hidden', 'true');
          setHeaderBelowModals(false);
        }
      }

      // Event listeners per la modale dettagli con supporto mobile
      eventClose?.addEventListener('click', closeEventDetails);
      eventClose2?.addEventListener('click', closeEventDetails);
      eventBackdrop?.addEventListener('click', closeEventDetails);

      // Event listeners per le impostazioni
      settingsClose?.addEventListener('click', closeSettingsModal);
      settingsClose2?.addEventListener('click', closeSettingsModal);
      settingsBackdrop?.addEventListener('click', closeSettingsModal);

      // Event listeners per controlli impostazioni
      document.getElementById('settingsSave')?.addEventListener('click', () => {
        saveSettings();
        closeSettingsModal();
      });

      document.getElementById('settingsReset')?.addEventListener('click', () => {
        if (confirm('Sei sicuro di voler ripristinare tutte le impostazioni ai valori predefiniti?')) {
          resetSettings();
        }
      });

      document.getElementById('requestNotificationPermission')?.addEventListener('click', requestNotificationPermission);

      document.getElementById('testSoundBtn')?.addEventListener('click', testNotificationSound);

      // Volume slider aggiornamento in tempo reale
      document.getElementById('settingVolume')?.addEventListener('input', (e) => {
        const volume = parseInt(e.target.value);
        document.getElementById('volumeLabel').textContent = volume + '%';
      });

      // Event listener per pulsanti tipo suono
      document.addEventListener('click', (e) => {
        if (e.target.closest('.sound-type-btn')) {
          const btn = e.target.closest('.sound-type-btn');
          const soundType = btn.dataset.sound;
          
          // Aggiorna campo nascosto
          const hiddenInput = document.getElementById('settingSoundType');
          if (hiddenInput) hiddenInput.value = soundType;
          
          // Aggiorna stile pulsanti
          document.querySelectorAll('.sound-type-btn').forEach(b => {
            b.removeAttribute('data-active');
          });
          btn.setAttribute('data-active', 'true');
          
          // Test automatico del suono selezionato
          currentSettings.soundType = soundType;
          playNotificationSound();
          notifications.add('info', `Tipo suono cambiato: ${soundType === 'system' ? 'Sistema' : 'Sirena'}`);
        }
      });

      // Pulsanti con supporto touch mobile
      const eventZoomBtn = document.getElementById('eventZoom');
      const getDirectionsBtn = document.getElementById('getDirections');

      if (eventZoomBtn) {
        eventZoomBtn.addEventListener('click', zoomToEvent);
        eventZoomBtn.addEventListener('touchstart', function(e) {
          e.preventDefault();
          zoomToEvent();
        }, { passive: false });
      }

      if (getDirectionsBtn) {
        getDirectionsBtn.addEventListener('click', getDirectionsToEvent);
        getDirectionsBtn.addEventListener('touchstart', function(e) {
          e.preventDefault();
          getDirectionsToEvent();
        }, { passive: false });
      }

      // Tasti scorciatoia
      document.addEventListener('keydown', (e) => {
        // Chiudi modale con ESC
        if (e.key === 'Escape' && eventModal.getAttribute('data-open') === 'true') {
          closeEventDetails();
          return;
        }

        if (e.ctrlKey || e.metaKey) {
          switch(e.key) {
            case 'r':
              e.preventDefault();
              loadAndRender();
              notifications.add('info', 'Ricaricamento manuale attivato');
              break;
            case 'f':
              e.preventDefault();
              document.getElementById('fabFilter').click();
              break;
          }
        }
      });

      // ======= GESTIONE MODALE STATISTICHE =======
      const statsModal = document.getElementById('statsModal');
      const statsBtn = document.getElementById('fabAnalytics');
      const statsClose = document.getElementById('statsClose');
      const statsBackdrop = document.getElementById('statsBackdrop');

      function openStatsModal() {
        calculateStatistics();
        statsModal.setAttribute('data-open', 'true');
        statsModal.setAttribute('aria-hidden', 'false');
        setHeaderBelowModals(true);
      }

      function closeStatsModal() {
        statsModal.setAttribute('data-open', 'false');
        statsModal.setAttribute('aria-hidden', 'true');
        setHeaderBelowModals(false);
      }

      function calculateStatistics() {
        const features = window.lastFeatures || [];
        const now = Date.now();

        // Calcoli base
        const totalOutages = features.length;
        let activeOutages = 0;
        let totalUsers = 0;
        let durations = [];
        const regionCounts = {};

        features.forEach(f => {
          const attrs = f.attributes || {};
          const users = Number(pickAttr(attrs, ['num_cli_disalim', 'clienti']) || 0);
          const startTime = Number(pickAttr(attrs, ['data_interruzione', 'data_inizio', 'inizio']) || 0); // Mappato correttamente
          const endTime = Number(pickAttr(attrs, ['data_fine_effettiva', 'fine_effettiva', 'end']) || 0); // Mappato correttamente
          const comune = pickAttr(attrs, ['comune', 'municipio']) || 'Sconosciuto';
          const provincia = pickAttr(attrs, ['provincia', 'prov']) || 'N/D';

          totalUsers += users;

          // Controlla se è attivo
          if (!endTime || endTime > now) {
            activeOutages++;
          }

          // Calcola durata se disponibile
          if (startTime && endTime && endTime > startTime) {
            durations.push(endTime - startTime);
          }

          // Conta per regione/provincia
          const key = provincia !== 'N/D' ? provincia : comune;
          regionCounts[key] = (regionCounts[key] || 0) + 1;
        });

        // Aggiorna UI
        document.getElementById('k_totGuasti').textContent = totalOutages.toLocaleString('it-IT');
        document.getElementById('k_attivi').textContent = activeOutages.toLocaleString('it-IT');
        document.getElementById('k_utenti').textContent = totalUsers.toLocaleString('it-IT');

        // Durata media
        const avgDuration = durations.length > 0 ? durations.reduce((a, b) => a + b, 0) / durations.length : 0;
        const avgHours = Math.round(avgDuration / (1000 * 60 * 60) * 10) / 10;
        document.getElementById('k_durata').textContent = avgDuration > 0 ? avgHours + 'h' : '—';

        // Top hotspots
        const hotspots = Object.entries(regionCounts)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 6);

        const hotspotsHTML = hotspots.map(([region, count]) => `
          <div class="hot">
            <div class="left">
              <div style="font-weight:700">${region}</div>
              <div class="hint">${count} eventi</div>
            </div>
            <div class="badge">${count}</div>
          </div>
        `).join('');

        document.getElementById('hotspotsList').innerHTML = hotspotsHTML || '<div style="text-align:center;color:#666;grid-column:1/-1">Nessun dato disponibile</div>';
      }

      statsBtn?.addEventListener('click', openStatsModal);
      statsClose?.addEventListener('click', closeStatsModal);
      statsBackdrop?.addEventListener('click', closeStatsModal);

      // Sistema di notifiche
      setInterval(updateConnectionStatus, 1000);
      setInterval(() => {
        if (navigator.onLine && currentSettings.notifications) {
          loadAndRender();
        }
      }, 30000);

      window.addEventListener('online', () => {
        notifications.add('success', 'Connessione ripristinata');
        updateConnectionStatus();
      });

      window.addEventListener('offline', () => {
        notifications.add('warning', 'Connessione persa - modalità offline');
        updateConnectionStatus();
      });

      // ======= GESTIONE MODALE FILTRI AVANZATI =======
      const filtersModal = document.getElementById('filtersModal');
      // Event listeners per filtri avanzati
      const filtersBtn = document.getElementById('fabFilter');
      const filtersClose = document.getElementById('filtersClose');
      const filtersBackdrop = document.getElementById('filtersBackdrop');

      if (filtersBtn) {
        filtersBtn.addEventListener('click', openFiltersModal);
      } else {
        console.error('Pulsante Filtri Avanzati non trovato');
      }

      if (filtersClose) {
        filtersClose.addEventListener('click', closeFiltersModal);
      }

      if (filtersBackdrop) {
        filtersBackdrop.addEventListener('click', closeFiltersModal);
      }

      function openFiltersModal() {
        loadSavedFilters(); // Carica i filtri salvati all'apertura
        updateFilterPreview().catch(console.error);
        filtersModal.setAttribute('data-open', 'true');
        filtersModal.setAttribute('aria-hidden', 'false');
        setHeaderBelowModals(true);
      }

      function closeFiltersModal() {
        filtersModal.setAttribute('data-open', 'false');
        filtersModal.setAttribute('aria-hidden', 'true');
        setHeaderBelowModals(false);
      }

      async function updateFilterPreview() {
        try {
          // Controlli di sicurezza per gli elementi DOM
          const regionEl = document.getElementById('fRegion');
          const causeEl = document.getElementById('fCause');
          const totalEl = document.getElementById('fTotal');
          const foundEl = document.getElementById('fFound');
          const activeCountEl = document.getElementById('fActiveCount');

          if (!regionEl || !causeEl || !totalEl || !foundEl || !activeCountEl) {
            console.warn('Alcuni elementi della modale filtri non sono disponibili');
            return;
          }

          // Usa i dati già caricati invece di fare nuove chiamate API
          const selectedRegion = regionEl.value;
          const selectedCause = causeEl.value;
          let features = window.lastFeatures || [];

          // Se non abbiamo dati o la regione è cambiata, usa i dati esistenti
          if (features.length === 0) {
            // Fallback ai dati esistenti
            features = [];
          }

          let filteredFeatures = features;

          // Applica filtri aggiuntivi con controlli di sicurezza
          const usersEl = document.getElementById('fUsers');
          const durationEl = document.getElementById('fDuration');
          const periodEl = document.getElementById('fPeriod');
          const addressEl = document.getElementById('fAddress');

          const selectedUsers = usersEl ? parseInt(usersEl.value) : 0;
          const selectedDuration = durationEl ? durationEl.value : 'any';

          if (selectedUsers > 0) {
            filteredFeatures = filteredFeatures.filter(f => {
              const users = Number(pickAttr(f.attributes, ['num_cli_disalim', 'clienti']) || 0);
              return users >= selectedUsers;
            });
          }

          if (selectedDuration !== 'any') {
            filteredFeatures = filteredFeatures.filter(f => {
              const attrs = f.attributes || {};
              const start = Number(pickAttr(attrs, ['data_interruzione', 'data_inizio', 'inizio']) || 0);
              const end = Number(pickAttr(attrs, ['data_prev_ripristino', 'data_fine_prevista', 'fine_prevista']) || 0);

              if (!start || !end) return true;

              const durationHours = (end - start) / (1000 * 60 * 60);

              switch (selectedDuration) {
                case 'lt1': return durationHours < 1;
                case '1to4': return durationHours >= 1 && durationHours <= 4;
                case 'gt4': return durationHours > 4;
                default: return true;
              }
            });
          }

          const total = features.length;
          const found = filteredFeatures.length;
          // Conta filtri attivi
          const tempFilters = {
            region: selectedRegion,
            cause: selectedCause,
            period: periodEl ? periodEl.value : 'all',
            address: addressEl ? addressEl.value.trim() : '',
            users: selectedUsers,
            duration: selectedDuration
          };

          const activeCount = Object.entries(tempFilters).filter(([key, value]) => {
            return value !== 'all' && value !== 'any' && value !== 0 && value !== '';
          }).length;

          // Calcola utenti coinvolti totali
          const affectedUsers = filteredFeatures.reduce((sum, f) => {
            const users = Number(pickAttr(f.attributes, ['num_cli_disalim', 'clienti']) || 0);
            return sum + users;
          }, 0);

          // Aggiorna UI con controlli di sicurezza
          totalEl.textContent = total;
          foundEl.textContent = found;
          activeCountEl.textContent = `${activeCount} filtri attivi`;
          
          const affectedUsersEl = document.getElementById('fAffectedUsers');
          if (affectedUsersEl) {
            affectedUsersEl.textContent = affectedUsers.toLocaleString('it-IT');
          }

        } catch (error) {
          console.error('Errore aggiornamento anteprima:', error);
          // Fallback ai dati correnti se l'aggiornamento fallisce con controlli di sicurezza
          const features = window.lastFeatures || [];
          const totalEl = document.getElementById('fTotal');
          const foundEl = document.getElementById('fFound');
          const activeCountEl = document.getElementById('fActiveCount');
          const affectedUsersEl = document.getElementById('fAffectedUsers');

          if (totalEl) totalEl.textContent = features.length;
          if (foundEl) foundEl.textContent = features.length;
          if (activeCountEl) activeCountEl.textContent = '0 filtri attivi';
          if (affectedUsersEl) {
            const totalUsers = features.reduce((sum, f) => {
              const users = Number(pickAttr(f.attributes, ['num_cli_disalim', 'clienti']) || 0);
              return sum + users;
            }, 0);
            affectedUsersEl.textContent = totalUsers.toLocaleString('it-IT');
          }
        }
      }

      // Geocoding semplice
      async function geocodeAddress(address) {
        try {
          const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=it&limit=1`);
          const data = await response.json();
          if (data && data[0]) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            map.setView([lat, lon], 12);
            L.popup()
              .setLatLng([lat, lon])
              .setContent(`📍 ${data[0].display_name}`)
              .openOn(map);
            notifications.add('success', `Trovato: ${data[0].display_name}`);
          } else {
            notifications.add('warning', 'Indirizzo non trovato');
          }
        } catch (err) {
          notifications.add('error', 'Errore nella ricerca indirizzo');
        }
      }

      // Funzioni di gestione filtri
      let activeFilters = {
        region: 'all',
        cause: 'all',
        period: 'all',
        address: '',
        users: 0,
        duration: 'any'
      };

      function applyFilters() {
        // Leggi i valori dai controlli
        activeFilters.region = document.getElementById('fRegion').value;
        activeFilters.cause = document.getElementById('fCause').value;
        activeFilters.period = document.getElementById('fPeriod').value;
        activeFilters.address = document.getElementById('fAddress').value.trim();
        activeFilters.users = parseInt(document.getElementById('fUsers').value);
        activeFilters.duration = document.getElementById('fDuration').value;

        // Aggiorna regione corrente se cambiata
        if (activeFilters.region !== 'all') {
          currentRegion = activeFilters.region;
          // Centra la mappa sulla regione selezionata
          if (REGION_BBOX[activeFilters.region]) {
            map.fitBounds(L.latLngBounds(REGION_BBOX[activeFilters.region]).pad(0.08));
          }
        } else {
          // Se "Tutte le Regioni", mostra tutta l'Italia
          currentRegion = 'Tutta Italia';
          map.setView([42.5,12.5], 6);
        }

        // Aggiorna causa corrente se cambiata
        if (activeFilters.cause !== 'all') {
          currentCause = activeFilters.cause;
          // Aggiorna anche i chip nella sidebar
          [...document.querySelectorAll('#causeChips .chip')].forEach(c => {
            c.dataset.active = c.dataset.value === activeFilters.cause ? 'true' : 'false';
          });
        } else {
          currentCause = 'all';
          // Reset chip sidebar
          [...document.querySelectorAll('#causeChips .chip')].forEach(c => {
            c.dataset.active = c.dataset.value === 'all' ? 'true' : 'false';
          });
        }

        // Ricarica e filtra i dati con la nuova regione
        loadAndRenderWithFilters();
        updateFilterPreview().catch(console.error);
        closeFiltersModal();

        const activeCount = Object.values(activeFilters).filter(v => v !== 'all' && v !== 'any' && v !== 0 && v !== '').length;
        notifications.add('success', `Filtri applicati (${activeCount} attivi) - Regione: ${currentRegion}`);
      }

      function resetFilters() {
        // Reset dei controlli con controlli di sicurezza
        const regionEl = document.getElementById('fRegion');
        const causeEl = document.getElementById('fCause');
        const periodEl = document.getElementById('fPeriod');
        const addressEl = document.getElementById('fAddress');
        const usersEl = document.getElementById('fUsers');
        const durationEl = document.getElementById('fDuration');
        const usersLabelEl = document.getElementById('fUsersLabel');

        if (regionEl) regionEl.value = 'all';
        if (causeEl) causeEl.value = 'all';
        if (periodEl) periodEl.value = 'all';
        if (addressEl) addressEl.value = '';
        if (usersEl) usersEl.value = '0';
        if (durationEl) durationEl.value = 'any';
        if (usersLabelEl) usersLabelEl.textContent = '0 - 10000+';

        // Reset delle variabili globali
        activeFilters = { region: 'all', cause: 'all', period: 'all', address: '', users: 0, duration: 'any' };
        currentCause = 'all';
        currentRegion = 'Calabria';

        // Reset chip sidebar
        [...document.querySelectorAll('#causeChips .chip')].forEach(c => {
          c.dataset.active = c.dataset.value === 'all' ? 'true' : 'false';
        });

        // Ritorna alla vista Calabria
        map.fitBounds(CALABRIA_BOUNDS.pad(0.08));

        // Rimuovi filtri salvati dal localStorage
        try {
          localStorage.removeItem('poweringuasti_filters');
        } catch (e) {
          console.warn('Impossibile rimuovere filtri salvati:', e);
        }

        loadAndRender();
        updateFilterPreview().catch(console.error);
        notifications.add('success', 'Filtri azzerati e rimossi dalle preferenze');
      }

      function saveFilters() {
        try {
          // Aggiorna activeFilters con i valori correnti prima di salvare
          const regionEl = document.getElementById('fRegion');
          const causeEl = document.getElementById('fCause');
          const periodEl = document.getElementById('fPeriod');
          const addressEl = document.getElementById('fAddress');
          const usersEl = document.getElementById('fUsers');
          const durationEl = document.getElementById('fDuration');

          if (regionEl) activeFilters.region = regionEl.value;
          if (causeEl) activeFilters.cause = causeEl.value;
          if (periodEl) activeFilters.period = periodEl.value;
          if (addressEl) activeFilters.address = addressEl.value.trim();
          if (usersEl) activeFilters.users = parseInt(usersEl.value);
          if (durationEl) activeFilters.duration = durationEl.value;

          localStorage.setItem('poweringuasti_filters', JSON.stringify(activeFilters));
          
          // Conta filtri attivi per feedback
          const activeCount = Object.entries(activeFilters).filter(([key, value]) => {
            return value !== 'all' && value !== 'any' && value !== 0 && value !== '';
          }).length;
          
          notifications.add('success', `Filtri salvati come predefiniti (${activeCount} attivi)`);
        } catch (e) {
          console.error('Errore salvataggio filtri:', e);
          notifications.add('error', 'Impossibile salvare i filtri - storage non disponibile');
        }
      }

      function loadSavedFilters() {
        try {
          const saved = localStorage.getItem('poweringuasti_filters');
          if (saved) {
            const filters = JSON.parse(saved);
            // Applica i filtri salvati ai controlli
            document.getElementById('fRegion').value = filters.region || 'all';
            document.getElementById('fCause').value = filters.cause || 'all';
            document.getElementById('fDuration').value = filters.duration || 'any';
            document.getElementById('fUsers').value = filters.users || '0';
            document.getElementById('fPeriod').value = filters.period || 'all';
            document.getElementById('fAddress').value = filters.address || '';

            // Aggiorna label utenti
            const usersValue = parseInt(filters.users || 0);
            document.getElementById('fUsersLabel').textContent = usersValue === 0 ? '0 - 10000+' : `${usersValue} - 10000+`;

            activeFilters = { ...filters }; // Aggiorna lo stato globale dei filtri
            updateFilterPreview().catch(console.error); // Aggiorna la preview con i filtri caricati
          }
        } catch (e) {
          console.warn('Impossibile caricare filtri salvati:', e);
        }
      }

      // Event listeners per i pulsanti della modale filtri
      document.getElementById('geocodeBtn')?.addEventListener('click', () => {
        const address = document.getElementById('fAddress').value.trim();
        if (address) geocodeAddress(address);
      });

      document.getElementById('fApply')?.addEventListener('click', applyFilters);
      document.getElementById('fReset')?.addEventListener('click', resetFilters);
      document.getElementById('fSave')?.addEventListener('click', () => {
        saveFilters();
        notifications.add('success', 'Filtri salvati come predefiniti sul dispositivo');
      });

      // Event listeners per aggiornamento preview in tempo reale
      ['fRegion', 'fCause', 'fPeriod', 'fDuration'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('change', () => {
            updateFilterPreview().catch(console.error);
          });
        }
      });

      // Event listener specifico per slider utenti
      const fUsersEl = document.getElementById('fUsers');
      if (fUsersEl) {
        fUsersEl.addEventListener('input', (e) => {
          const value = parseInt(e.target.value);
          document.getElementById('fUsersLabel').textContent = value === 0 ? '0 - 10000+' : `${value} - 10000+`;
          updateFilterPreview().catch(console.error);
        });
      }

      // Test completo funzionalità mobile
      function testMobileFunctionality() {
        const tests = [
          { name: 'FAB Filtri', element: document.getElementById('fabFilter') },
          { name: 'FAB Analytics', element: document.getElementById('fabAnalytics') },
          { name: 'FAB Layers', element: document.getElementById('fabLayers') },
          { name: 'FAB Settings', element: document.getElementById('fabSettings') },
          { name: 'FAB Refresh', element: document.getElementById('fabRefresh') },
          { name: 'Fit Calabria', element: document.getElementById('fitCalabria') },
          { name: 'Fit Italy', element: document.getElementById('fitItaly') }
        ];

        let workingButtons = 0;
        tests.forEach(test => {
          if (test.element && typeof test.element.click === 'function') {
            workingButtons++;
            addTest(test.name, true, 'Funzionante');
          } else {
            addTest(test.name, false, 'Non trovato');
          }
        });

        const totalButtons = tests.length;
        const percentage = Math.round((workingButtons / totalButtons) * 100);
        notifications.add('info', `Test UI: ${workingButtons}/${totalButtons} pulsanti (${percentage}%) funzionanti`);

        // Test touch events per mobile
        if ('ontouchstart' in window) {
          notifications.add('success', 'Touch events supportati - Dispositivo mobile rilevato');
        }
      }

      // Start con notifica iniziale e test
      updateConnectionStatus();
      updateMobileFunctionality();
      loadAndRender();
      setTimeout(testMobileFunctionality, 1000);
      notifications.add('success', 'Sistema di monitoraggio inizializzato per mobile', false);
    }

    if (window.L) {
      runApp();
    } else {
      const s = document.getElementById('leafletjs');
      if (s) {
        s.addEventListener('load', () => { if (window.L) runApp(); else { const box = document.getElementById('errorOverlay'); if(box){ box.style.display='block'; box.textContent = 'Impossibile caricare Leaflet'; } } });
        s.addEventListener('error', () => { const box = document.getElementById('errorOverlay'); if(box){ box.style.display='block'; box.textContent = 'Errore nel caricamento di Leaflet'; } });
      } else {
        window.addEventListener('load', () => { if (window.L) runApp(); else { const box = document.getElementById('errorOverlay'); if(box){ box.style.display='block'; box.textContent = 'Leaflet non disponibile'; } } });
      }
    }
  })();
  </script>
</body>
</html>